<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet type="text/xsl" ?>
<casaxml xmlns="http://casa.nrao.edu/schema/psetTypes.html"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://casa.nrao.edu/schema/casa.xsd
      file:///opt/casa/code/xmlcasa/xml/casa.xsd">

    <task type="function" name="tflagdata" category="editing" visibility="experimental">
        <shortdescription> All purpose flagging task based on selections or a list of commands</shortdescription>
        <description>
            This task has two main types of operation. One type
            will read the parameters from the interface and flag
            using any of the various modes available. Ther other type
            will read the commands from a list containing data selection
            parameters and any parameter specific for the mode being 
            requested in each line. See examples at the end of this
            help.
            
            It is also possible to only save the parameters set in the
            interface without flagging. The parameters can be saved
            in the FLAG_CMD sub-table or in the provided ASCII file. Note that
            when saving to an external file, the parameters will be appended to
            the given file.
            
            The available flagging modes are: manual, clip, shadow, quack,
            elevation, tfcrop, extend, unflag and summary.

            The current flags an be automatically backed up before applying new flags
            if the parameter flagbackup is set. Previous flag versions can be recovered 
            using the flagmanager task.
        </description>

        <input>
            <param type="string" name="vis" mustexist="true">
                <description>Name of MS file to flag</description>
                <value />
            </param>

            <param type="string" name="mode">
                <description>Flagging mode (list,manual,clip,shadow,quack,elevation,\
tfcrop,rflag,extend,unflag,summary)</description>
                <value>manual</value>
                <allowed kind="enum">
                    <value>list</value>
                    <value>manual</value>
                    <value>clip</value>
                    <value>shadow</value>
                    <value>quack</value>
                    <value>elevation</value>
                    <value>tfcrop</value>
                    <value>rflag</value>
                    <value>extend</value>
                    <value>unflag</value>
                    <value>summary</value>
                </allowed>
            </param>

            <param type="string" name="inpfile" subparam="true">
                <description>Input file with list of commands to run</description>
                <value></value>
            </param>
            <param type="any" name="reason" subparam="true">
                        <description>Select by REASON types</description>
                        <any type="variant" limittypes="string stringArray"/>
                        <value type="string">any</value>
            </param>
            
            <!-- SELECTION parameters -->
            <param type="any" name="spw" subparam="true">
                <description>spectral-window/frequency/channel</description>
                <any type="variant" limittypes="string stringArray" />
                <value type="string" />
            </param>
            <param type="any" name="field" subparam="true">
                <description>Field names or field index numbers: \'\'==>all, field=\'0~2,3C286\'</description>
                <any type="variant" limittypes="string stringArray" />
                <value type="string" />
            </param>
            <param type="any" name="antenna" subparam="true">
                <description>antenna/baselines: \'\'==>all, antenna =\'3,VA04\'</description>
                <any type="variant" limittypes="string stringArray" />
                <value type="string" />
            </param>
            <param type="any" name="uvrange" subparam="true">
                <description>uv range: \'\'==>all; uvrange =\'0~100klambda\', default units=meters</description>
                <any type="variant" limittypes="string stringArray" />
                <value type="string" />
            </param>
            <param type="any" name="timerange" subparam="true"><description>time range: \'\'==>all,timerange=\'09:14:0~09:54:0\'</description>
                <any type="variant" limittypes="string stringArray" />
                <value type="string" />
            </param>
            <param type="any" name="correlation" subparam="true">
                <description>Select data based on correlation</description>
                <any type="variant" limittypes="string stringArray" />
                <value type="string" />
            </param>
            <param type="any" name="scan" subparam="true">
                <description>scan numbers: \'\'==>all</description>
                <any type="variant" limittypes="string stringArray" />
                <value type="string" />
            </param>
            <param type="any" name="intent" subparam="true">
                <description>Select data based on observation intent: \'\'==>all</description>
                <any type="variant" limittypes="string stringArray" />
                <value type="string" />
            </param>
            <param type="any" name="feed" subparam="true">
                <description>multi-feed numbers: Not yet implemented</description>
                <any type="variant" limittypes="string stringArray" />
                <value type="string" />
            </param>
            <param type="any" name="array" subparam="true">
                <description>(sub)array numbers: \'\'==>all</description>
                <any type="variant" limittypes="string stringArray" />
                <value type="string" />
            </param>
            <param type="any" name="observation" subparam="true">
                <description>Select data based on observation ID: \'\'==>all</description>
                <any type="variant" limittypes="string int" />
                <value type="string" />
            </param>

            <!-- CLIP parameters -->
            <param type="any" name="clipminmax" subparam="true">
                <description>Range to use for clipping</description>
                <any type="variant" limittypes="doubleArray doubleArrayArray" />
                <value type="doubleArray"></value>
            </param>
            <param type="any" name="datacolumn" subparam="true">
                <description>Data column on which to operate (data,corrected,model,residual)</description>
                <any type="variant" limittypes="string stringArray" />
                <value type="string">DATA</value>
            </param>
            <param type="any" name="clipoutside" subparam="true">
                <description>Clip outside the range, or within it</description>
                <any type="variant" limittypes="bool boolArray" />
                <value type="bool">True</value>
            </param>
            <param type="any" name="channelavg" subparam="true">
                <description>Average over channels (scalar average)</description>
                <any type="variant" limittypes="bool boolArray" />
                <value type="bool">False</value>
            </param>
            <param type="bool" name="clipzeros" subparam="true">
                <description>Clip zero-value data</description>
                <value type="bool">False</value>
            </param>

            <!-- QUACK parameters -->
            <param type="any" name="quackinterval" subparam="true">
                <description>Quack n seconds from scan beginning or end</description>
                <any type="variant" limittypes="double doubleArray" />
                <value type="double">0.0</value>
            </param>
            <param type="any" name="quackmode" subparam="true">
                <description>Quack mode. \'beg\' ==> beginning of scan.\'endb\' ==> end of scan. \'end\' ==> all but end of scan. \'tail\' ==> all but beginning of scan</description>
                <any type="variant" limittypes="string stringArray" />
                <value type="string">beg</value>
            </param>
            <param type="any" name="quackincrement" subparam="true">
                <description>Flag incrementally in time?</description>
                <any type="variant" limittypes="bool boolArray" />
                <value type="bool">False</value>
            </param>

            <!-- SHADOW parameters -->
            <param type="double" name="tolerance" subparam="true">
                <description>Amount of shadow allowed (in meters)</description>
                <value>0.0</value>
            </param>
            <param type="any" name="addantenna" subparam="true">
                <description>File name or dictionary with additional antenna names, positions and diameters</description>
                <any type='variant' limittype='string record'/>
                <value type="string"></value>
            </param>
            
            <!-- ELEVATION parameters -->            
            <param type="double" name="lowerlimit" subparam="true">
                <description>Lower limiting elevation (in degrees)</description>
                <value>0.0</value>
            </param>
            <param type="double" name="upperlimit" subparam="true">
                <description>Upper limiting elevation (in degrees)</description>
                <value>90.0</value>
            </param>

             <!-- TFCROP parameters -->
            <param type="any" name="ntime" subparam="true">
                <description>Time-range to use for each chunk (in seconds or minutes)</description>
                <any type="variant" limittypes="double string" />
                <value type="string">scan</value>
            </param>
            <param type="bool" name="combinescans" subparam="true">
                <description>Accumulate data across scans.</description>
                <value>False</value>
            </param>
            <param type="double" name="timecutoff" subparam="true">
                <description>Flagging thresholds in units of deviation from the fit</description>
                <value>4.0</value>
            </param>
            <param type="double" name="freqcutoff" subparam="true">
                <description>Flagging thresholds in units of deviation from the fit</description>
                <value>3.0</value>
            </param>
            <param type="string" name="timefit" subparam="true">
                <description>Fitting function for the time direction (poly/line)</description>
                <value>line</value>
            </param>
            <param type="string" name="freqfit" subparam="true">
                <description>Fitting function for the frequency direction (poly/line)</description>
                <value>poly</value>
            </param>
            <param type="int" name="maxnpieces" subparam="true">
                <description>Number of pieces in the polynomial-fits (for \'freqfit\' or \'timefit\' = \'poly\')</description>
                <value>7</value>
            </param>
            <param type="string" name="flagdimension" subparam="true">
                <description>Dimensions along which to calculate fits (freq/time/freqtime/timefreq)</description>
                <value>freqtime</value>
            </param>
            <param type="string" name="usewindowstats" subparam="true">
                <description>Calculate additional flags using sliding window statistics (none,sum,std,both)</description>
                <value>none</value>
            </param>
            <param type="int" name="halfwin" subparam="true">
                <description>Half-width of sliding window to use with \'usewindowstats\' (1,2,3).</description>
                <value>1</value>
            </param>

            <!-- RFLAG parameters -->
            <param type="int" name="winsize" subparam="true">
                <description>Size of sliding time window [aips:fparm(1)]</description>
                <value>3</value>
            </param>
            <param type="any" name="timedev" subparam="true">
                <description>Time-series noise estimate [aips:noise]</description>
                <any type="variant" />
                <value type="string"></value>
            </param>
            <param type="any" name="freqdev" subparam="true">
                <description>Spectral noise estimate [aips:scutoff]</description>
                <any type="variant" />
                <value type="string"></value>
            </param>
            <param type="double" name="timedevscale" subparam="true">
                <description>Threshold scaling for timedev [aips:fparm(9)]</description>
                <value>5.0</value>
            </param>
            <param type="double" name="freqdevscale" subparam="true">
                <description>Threshold scaling for freqdev [aips:fparm(10)]</description>
                <value>5.0</value>
            </param>
            <param type="double" name="spectralmax" subparam="true">
                <description>Flag whole spectrum if freqdev is greater than spectralmax [aips:fparm(6)]</description>
                <value>1E6</value>
            </param>
            <param type="double" name="spectralmin" subparam="true">
                <description>Flag whole spectrum if freqdev is less than spectralmin [aips:fparm(5)] </description>
                <value>0.0</value>
            </param>


            <!-- EXTEND parameters -->
            <param type="any" name="extendpols" subparam="true">
                <description>If any correlation is flagged, flag all correlations</description>
                <value type="bool">True</value>
            </param>

           <param type="double" name="growtime" subparam="true">
                <description>Flag all \'ntime\' integrations if more than X% of the timerange is flagged (0-100)</description>
                <value>90.0</value>
            </param>
            <param type="double" name="growfreq" subparam="true">
                <description>Flag all selected channels if more than X% of the frequency range is flagged(0-100)</description>
                <value>90.0</value>
            </param>
            <param type="bool" name="growaround" subparam="true">
                <description>Flag data based on surrounding flags</description>
                <value type="bool">False</value>
            </param>
            <param type="bool" name="flagneartime" subparam="true">
                <description>Flag one timestep before and after a flagged one (True/False)</description>
                <value type="bool">False</value>
            </param>
            <param type="bool" name="flagnearfreq" subparam="true">
                <description>Flag one channel before and after a flagged one (True/False)</description>
                <value type="bool">False</value>
            </param>


            <!-- SUMMARY parameters -->
             <param type="double" name="minrel" subparam="true">
                <description>minimum number of flags (relative)</description>
                <value type="double">0.0</value>
            </param>             
            <param type="double" name="maxrel" subparam="true">
                <description>maximum number of flags (relative)</description>
                <value type="double">1.0</value>
            </param>
            <param type="int" name="minabs" subparam="true">
                <description>minimum number of flags (absolute)</description>
                <value type="int">0</value>
            </param>
            <param type="int" name="maxabs" subparam="true">
                <description>maximum number of flags (absolute). Use a negative value to indicate infinity.</description>
                <value type="int">-1</value>
            </param>
            <param type="bool" name="spwchan" subparam="true">
                <description>Print summary of channels per spw</description>
                <value type="bool">False</value>
            </param>
            <param type="bool" name="spwcorr" subparam="true">
                <description>Print summary of correlation per spw</description>
                <value type="bool">False</value>
            </param>
            <param type="bool" name="basecnt" subparam="true">
                <description>Print summary counts per baseline</description>
                <value type="bool">False</value>
            </param>


            <!-- RUN parameters -->
            <param type="bool" name="run">
                <description>Run and flag based on the parameters or the list given in inpfile</description>
                <value>True</value>
            </param>
            <param type="bool" name="writeflags" subparam="true">
                <description>Write Flags to the MS</description>
                <value>True</value>
            </param>
            <param type="string" name="display" subparam="true">
                <description>Display data and/or end-of-MS reports at runtime (data, report, both).</description>
                <value type="string"></value>
            </param>
            <param type="bool" name="flagbackup" subparam="true">
                <description>Back up the state of flags before the run</description>
                <value>True</value>
            </param>


            <!-- SAVEPARS parameter -->
            <param type="bool" name="savepars">
                <description>Save the current parameters to the MS or to a file</description>
                <value>False</value>
            </param>
            <param type="string" name="outfile" subparam="true">
                    <description>Name of output file to save current parameters. If empty, save to FLAG_CMD</description>
                    <value></value>
            </param>

            <constraints>                    
                <when param="mode">
                    <equals value="manual">
                        <default param="field"><value type="string"></value></default>
                        <default param="spw"><value type="string"></value></default>
                        <default param="antenna"><value type="string"></value></default>
                        <default param="timerange"><value type="string"></value></default>
                        <default param="correlation"><value type="string"></value></default>
                        <default param="scan"><value type="string"></value></default>
                        <default param="intent"><value type="string"></value></default>
                        <default param="feed"><value type="string"></value></default>
                        <default param="array"><value type="string"></value></default>
                        <default param="uvrange"><value type="string"></value></default>
                        <default param="observation"><value type="string"></value></default>
                    </equals>
                    <equals value="list">
                        <default param="inpfile"><value type="string"></value></default>
                        <default param="reason"><value type="string">any</value></default>
                    </equals>
                    <equals value="clip">
                        <default param="field"><value type="string"></value></default>
                        <default param="spw"><value type="string"></value></default>
                        <default param="antenna"><value type="string"></value></default>
                        <default param="timerange"><value type="string"></value></default>
                        <default param="correlation"><value type="string"></value></default>
                        <default param="scan"><value type="string"></value></default>
                        <default param="intent"><value type="string"></value></default>
                        <default param="feed"><value type="string"></value></default>
                        <default param="array"><value type="string"></value></default>
                        <default param="uvrange"><value type="string"></value></default>
                        <default param="observation"><value type="string"></value></default>
                        <default param="datacolumn"><value type="string">DATA</value></default>
                        <default param="clipminmax"><value type="doubleArray"></value></default>
                        <default param="clipoutside"><value type="bool">True</value></default>
                        <default param="channelavg"> <value type="bool">False</value></default>
                        <default param="clipzeros"> <value type="bool">False</value></default>
                    </equals>
                    <equals value="quack">
                        <default param="field"><value type="string"></value></default>
                        <default param="spw"><value type="string"></value></default>
                        <default param="antenna"><value type="string"></value></default>
                        <default param="timerange"><value type="string"></value></default>
                        <default param="correlation"><value type="string"></value></default>
                        <default param="scan"><value type="string"></value></default>
                        <default param="intent"><value type="string"></value></default>
                        <default param="feed"><value type="string"></value></default>
                        <default param="array"><value type="string"></value></default>
                        <default param="uvrange"><value type="string"></value></default>
                        <default param="observation"><value type="string"></value></default>
                        <default param="quackinterval"><value type="double">0.0</value></default>
                        <default param="quackmode"><value type="string">beg</value></default>
                        <default param="quackincrement"><value type="bool">False</value></default>                   
                    </equals>                    
                    <equals value="shadow">
                        <default param="field"><value type="string"></value></default>
                        <default param="spw"><value type="string"></value></default>
                        <default param="antenna"><value type="string"></value></default>
                        <default param="timerange"><value type="string"></value></default>
                        <default param="correlation"><value type="string"></value></default>
                        <default param="scan"><value type="string"></value></default>
                        <default param="intent"><value type="string"></value></default>
                        <default param="feed"><value type="string"></value></default>
                        <default param="array"><value type="string"></value></default>
                        <default param="uvrange"><value type="string"></value></default>
                        <default param="observation"><value type="string"></value></default>
                        <default param="tolerance"><value type="double">0.0</value></default>
                        <default param="addantenna"><value type="string"></value></default>
                    </equals>
                    <equals value="elevation">
                        <default param="field"><value type="string"></value></default>
                        <default param="spw"><value type="string"></value></default>
                        <default param="antenna"><value type="string"></value></default>
                        <default param="timerange"><value type="string"></value></default>
                        <default param="correlation"><value type="string"></value></default>
                        <default param="scan"><value type="string"></value></default>
                        <default param="intent"><value type="string"></value></default>
                        <default param="feed"><value type="string"></value></default>
                        <default param="array"><value type="string"></value></default>
                        <default param="uvrange"><value type="string"></value></default>
                        <default param="observation"><value type="string"></value></default>
                        <default param="lowerlimit"><value type="double">0.0</value></default>
                        <default param="upperlimit"><value type="double">90.0</value></default>                    
                    </equals>
                    <equals value="tfcrop">
                        <default param="field"><value type="string"></value></default>
                        <default param="spw"><value type="string"></value></default>
                        <default param="antenna"><value type="string"></value></default>
                        <default param="timerange"><value type="string"></value></default>
                        <default param="correlation"><value type="string"></value></default>
                        <default param="scan"><value type="string"></value></default>
                        <default param="intent"><value type="string"></value></default>
                        <default param="feed"><value type="string"></value></default>
                        <default param="array"><value type="string"></value></default>
                        <default param="uvrange"><value type="string"></value></default>
                        <default param="observation"><value type="string"></value></default>
                        <default param="ntime"><value type="string">scan</value></default>
                        <default param="combinescans"><value type="bool">False</value></default>
                        <default param="datacolumn"><value type="string">DATA</value></default>
                        <default param="timecutoff"><value type="double">4.0</value></default>
                        <default param="freqcutoff"><value type="double">3.0</value></default>
                        <default param="timefit"><value type="string">line</value></default>
                        <default param="freqfit"><value type="string">poly</value></default>
                        <default param="maxnpieces"><value type="int">7</value></default>
                        <default param="flagdimension"><value type="string">freqtime</value></default>
                        <default param="usewindowstats"><value type="string">none</value></default>
                        <default param="halfwin"><value type="int">1</value></default>                    
                    </equals>
                    <equals value="rflag">
                        <default param="field"><value type="string"></value></default>
                        <default param="spw"><value type="string"></value></default>
                        <default param="antenna"><value type="string"></value></default>
                        <default param="timerange"><value type="string"></value></default>
                        <default param="correlation"><value type="string"></value></default>
                        <default param="scan"><value type="string"></value></default>
                        <default param="intent"><value type="string"></value></default>
                        <default param="feed"><value type="string"></value></default>
                        <default param="array"><value type="string"></value></default>
                        <default param="uvrange"><value type="string"></value></default>
                        <default param="observation"><value type="string"></value></default>
                        <default param="winsize"><value type="int">3</value></default>
                        <default param="timedev"><value type="string"></value></default>
                        <default param="freqdev"><value type="string"></value></default>
                        <default param="timedevscale"><value type="double">5.0</value></default>
                        <default param="freqdevscale"><value type="double">5.0</value></default>
                        <default param="spectralmax"><value type="double">1E6</value></default>
                        <default param="spectralmin"><value type="double">0.0</value></default>
                    </equals>
                    <equals value="extend">
                        <default param="field"><value type="string"></value></default>
                        <default param="spw"><value type="string"></value></default>
                        <default param="antenna"><value type="string"></value></default>
                        <default param="timerange"><value type="string"></value></default>
                        <default param="correlation"><value type="string"></value></default>
                        <default param="scan"><value type="string"></value></default>
                        <default param="intent"><value type="string"></value></default>
                        <default param="feed"><value type="string"></value></default>
                        <default param="array"><value type="string"></value></default>
                        <default param="uvrange"><value type="string"></value></default>
                        <default param="observation"><value type="string"></value></default>
                        <default param="ntime"><value type="string">scan</value></default>
                        <default param="combinescans"><value type="bool">False</value></default>
                        <default param="extendpols"><value type="bool">True</value></default>
                        <default param="growtime"><value type="double">90.0</value></default>
                        <default param="growfreq"><value type="double">90.0</value></default>
                        <default param="growaround"><value type="bool">False</value></default>
                        <default param="flagneartime"><value type="bool">False</value></default>
                        <default param="flagnearfreq"><value type="bool">False</value></default>                    
                    </equals>
                    <equals value="unflag">
                        <default param="field"><value type="string"></value></default>
                        <default param="spw"><value type="string"></value></default>
                        <default param="antenna"><value type="string"></value></default>
                        <default param="timerange"><value type="string"></value></default>
                        <default param="correlation"><value type="string"></value></default>
                        <default param="scan"><value type="string"></value></default>
                        <default param="intent"><value type="string"></value></default>
                        <default param="feed"><value type="string"></value></default>
                        <default param="array"><value type="string"></value></default>
                        <default param="uvrange"><value type="string"></value></default>
                        <default param="observation"><value type="string"></value></default>                    
                    </equals>
                    <equals value="summary">
                        <default param="field"><value type="string"></value></default>
                        <default param="spw"><value type="string"></value></default>
                        <default param="antenna"><value type="string"></value></default>
                        <default param="timerange"><value type="string"></value></default>
                        <default param="correlation"><value type="string"></value></default>
                        <default param="scan"><value type="string"></value></default>
                        <default param="intent"><value type="string"></value></default>
                        <default param="feed"><value type="string"></value></default>
                        <default param="array"><value type="string"></value></default>
                        <default param="uvrange"><value type="string"></value></default>
                        <default param="observation"><value type="string"></value></default>
                        <default param="minrel"><value type="double">0.0</value></default>
                         <default param="maxrel"><value type="double">1.0</value></default>
                        <default param="minabs"><value type="int">0</value></default>
                        <default param="maxabs"><value type="int">-1</value></default>
                        <default param="spwchan"><value type="bool">False</value></default>
                        <default param="spwcorr"><value type="bool">False</value></default>
                        <default param="basecnt"><value type="bool">False</value></default>  
                    </equals>
                </when>

                <when param="run">
                    <equals type="bool" value="True">
                        <default param="writeflags"><value type="bool">True</value></default>
                        <default param="display"><value type="string"></value></default>
                        <default param="flagbackup"><value type="bool">True</value></default>
                    </equals>
                </when>
                               
               <when param="savepars">
                <equals type="bool" value="False" />
                 <equals type="bool" value="True">
                    <default param="outfile"><value type="string"></value></default>
                </equals>
               </when>
                
             </constraints>
        </input>
<returns type="void"/>
<example>
        The task will flag a subset of data or a list of commands using any of the modes:
            list        = list of flagging commands to apply to MS
            manual      = flagging based on specific selection parameters
            clip        = clip data according to values
            quack       = remove/keep specific time range at scan beginning/end
            shadow      = remove antenna-shadowed data
            elevation   = remove data below/above given elevations
            tfcrop      = automatic identification and flagging of RFI
            rflag       = automatic detection of outliers based on sliding-window RMS
            extend      = extend and/or grow flags beyond what the basic algorithms detect
            summary     = report the amount of flagged data
            unflag      = unflag the specified data.
    
        Keyword arguments:
        vis -- Name of input visibility file
                default: '' (none) 
		        example: vis='ngc5921.ms'

          Any flagging will only be applied to the specified selection.

              antenna -- Select data based on baseline
                    default: '' (all); example: antenna='5&amp;6' baseline 5-6
                    antenna='5&amp;6;7&amp;8' #baseline 5-6 and 7-8
                    antenna='5' # all cross-correlation baselines between antenna 5 and all other available
                                  antennas
                    antenna='5,6' # all baselines with antennas 5 and 6
                    antenna='1&amp;&amp;1' # only the auto-correlation baselines for antenna 1
                    antenna='1&amp;&amp;*' # cross and auto-correlation baselines between antenna 1
                                             and all other available antennas
                    antenna='1~7&amp;&amp;&amp;' # only the auto-correlation baselines for antennas in range 1~7

              spw -- Select data based on spectral window and channels
                    default: '' (all); example: spw='1'
                    spw='&lt;2' #spectral windows less than 2
                    spw='&gt;1' #spectral windows greater than 1
                    spw='0:0~10' # first 10 channels from spw 0
                    spw='0:0~5;56~60' # multiple separated channel chunks.

              correlation -- Correlation types or expression.
                    default: '' (all correlations or 'ABS_ALL' for modes clip and tfcrop);
                    example: correlation='RR,LL' or
                    options: Any of 'ABS', 'ARG', 'RE', 'IM', 'NORM' followed by
                             any of 'ALL', 'I', 'XX', 'YY', 'RR', 'LL', 'WVR'
                             'WVR' refers to the water vapour radiometer of ALMA data.
                    example: correlation='RE_XX,XY'
                    
                    Note that the operators ABS,ARG,RE, etc are written only once as the first value.
                    if more than one correlation is given, the operator will be applied to all of them.
                    
					
                    The expression is used in modes clip and tfcrop only.            

			  field -- Select data based on field id(s) or name(s)
                    default: '' (all); example: field='1'
                    field='0~2' # field ids inclusive from 0 to 2
                    field='3C*' # all field names starting with 3C

              uvrange -- Select data within uvrange (default units meters)
                    default: '' (all); example:
                    uvrange='0~1000klambda'; uvrange from 0-1000 kilo-lamgda
                    uvrange='&gt;4klamda';uvranges greater than 4 kilo-lambda
                    uvrange='0~1000km'; uvrange in kilometers

              timerange  -- Select data based on time range:
                    default = '' (all); example,
                    timerange = 'YYYY/MM/DD/hh:mm:ss~YYYY/MM/DD/hh:mm:ss'
                    Note: YYYY/MM/DD can be dropped as needed:
                    timerange='09:14:0~09:54:0' # this time range
                    timerange='09:44:00' # data within one integration of time
                    timerange='&gt;10:24:00' # data after this time
                    timerange='09:44:00+00:13:00' #data 13 minutes after time

              scan -- Select data based on scan number
                    default: '' (all); example: scan='&gt;3'

              intent -- Select data based on observation intent
                    default: '' (all); example: intent='*CAL*,*BAND*'

              feed -- Selection based on the feed - NOT IMPLEMENTED YET

              array -- Selection based on the antenna array

              observation -- Selection based on the observation ID
                    default: '' (all); example: observation='1' or observation=1

        mode -- Mode of operation.
                options: 'list', 'manual','clip','quack','shadow','elevation', 'tfcrop', 'extend',
                         'unflag', 'summary'
                default: 'manual'

            list -- Flag according to the data selection specified in the input list.
                  Each input line may contain data selection parameters and any parameter
                  specific to the mode given in the line. Default values will be used for
                  the parameters that are not present in the line. Each line will be taken 
                  as a command to the task. If data is pre-selected using any of the selection 
                  parameters, then flagging will apply only to that subset of the MS.
                  
                  The summary mode is not allowed in the input list.
                  
                  For optimization, the task will create a union of the data selection parameters
                  present in the list and select only that portion of the MS.
                  
               inpfile -- Input ASCII file containing a list of commands to the task.
                  default: ''
                  Example: the following commands can be put in a file and given to the task.
                  
                     scan=1~3 mode=manual
                     mode=clip clipminmax=[0,2] correlation=ABS_XX clipoutside=False
                     spw=9 mode=tfcrop correlation=ABS_YY ntime=51.0 spw=9
                     mode=extend extendpols=True

               reason -- select flag commands based on REASON(s) 
                   default: 'any' (all flags regardless of reason)
                            can be a string, or list of strings
                   example: reason='FOCUS_ERROR'
                            reason=['FOCUS_ERROR','SUBREFLECTOR_ERROR']

                   NOTE: what is within the string is literally
                   mateched, e.g. reason='' matches only blank reasons, 
                   and reason = 'FOCUS_ERROR,SUBREFLECTOR_ERROR'
                   matches this compound reason string only
                     
                  See the syntax for writing flag commands at the end of this help.                  


            manual -- Flag according to the data selection specified.
                  
            clip -- Clip data according to values of the following subparameters.
                    
               channelavg -- Average data over (selected) channels? Channel
                            selections are taken into account. Flagged channels
                            are excluded from the average. The average is done
                            after applying the specified clipexpr, i.e. scalar
                            averaging.
                    default: False
                    options: True,False
                    
               clipminmax -- Range of data (Jy) that will NOT be flagged
                    default: []; it will flag only the NaN data.
                    example: [0.0,1.5]
                    It will always flag the NaN data, independent of the values used.
                    
               datacolumn -- Column to use for clipping.
                    default: 'DATA'
                    options: 'DATA','CORRECTED','MODEL', 'RESIDUAL, "RESIDUAL_DATA"
                    
               clipoutside -- Clip OUTSIDE the range?
                    default: True
                    example: False; flag data WITHIN the range.

               clipzeros -- Clip zero-value data.
                    default: False

            quack -- Option to remove specified part of scan beginning/end

                quackinterval -- Time in seconds from scan beginning/end to flag. Make time slightly 
                                 smaller than the desired time.
                    default: 0.0
                quackmode -- Quack mode
                    default: 'beg'
                    options: 'beg'  ==> beginning of scan
                             'endb' ==> end of scan. 
                             'tail' ==> all but beginning of scan
                             'end'  ==> all but end of scan.
                quackincrement -- Quack incrementally in time?
                    default: False
                             False  ==> the quack interval is counted from the
                                        beginning of the scan
                             True   ==> the quack interval is counted from the
                                        first unflagged data in the scan

            shadow -- Option to flag data of shadowed antennas.
                           All antennas in the antenna-subtable of the MS will be considered
                           for shadow-flag calculations.
                     
                tolerance -- Amount of shadowing allowed...
                   default: 0.0

                addantenna -- It can be either a file name with additional antenna names, positions 
                 and diameters, or a Python dictionary with the same information. You can use the flaghelper
                 functions to create the dictionary from a file.  
                   default: ''
                   
                   To create a dictionary inside casapy.
                   > import flaghelper as fh
                   > antdic = fh.readAntennaList(antfile)
                   
                   Where antfile is a text file in disk that contains information such as:
                    name=VLA01
                    diameter=25.0
                    position=[-1601144.96146691, -5041998.01971858, 3554864.76811967]
                    name=VLA02
                    diameter=25.0
                    position=[-1601105.7664601889, -5042022.3917835914, 3554847.245159178]
                  

            elevation -- Option to flag based on antenna elevation
                 
               lowerlimit -- Lower limiting elevation in degrees. Data coming from a baseline
                             where one or both antennas were pointing at a strictly lower elevation
                             (as function of time), will be flagged.
                   default: 0.0
                   
               upperlimit -- Upper limiting elevation in degrees. Data coming from a baseline
                             where one or both antennas were pointing at a strictly higher elevation
                             (as function of time), will be flagged.
                   default: 90.0

            tfcrop -- Flag using the TFCrop autoflag algorithm

               ntime -- Timerange (in seconds or minutes) over which to accumulate data before running the algorithms. 
                    options: 'scan' or any other float value or string containing the units.
                    default: 'scan'
                    example: '1.5min'
                           : 1.2 (taken in seconds)
                        The dataset will be iterated through in time-chunks defined here.
                
               combinescans -- accumulate data across scans.
                    default: False
                        It only makes sense when ntime not equal 'scan'.                

               datacolumn -- Column to use for flagging.
                    default: 'DATA'
                    options: 'DATA','CORRECTED','MODEL', 'RESIDUAL, "RESIDUAL_DATA"

               timecutoff -- Flag threshold in time. Flag all data-points further than N-stddev from the fit.
                    default: 4.0
                          Flagging is done in upto 5 iterations. The stddev calculation is adaptive and 
                          converges to a value that reflects only the data and no RFI. At each iteration,
                          the same relative threshold is applied to detect flags. (Step (3) of the algorithm).

               freqcutoff -- Flag threshold in frequency. Flag all data-points further than N-stddev from the fit.
                    default: 3.0
                        Same as above, and is used in Steps (1) and (2) of the algorithm.                       

               timefit --  Fitting function for the time direction
                    default: 'line'
                    options: 'line', 'poly'
                      A 'line' fit is a robust straight-line fit across the entire timerange (defined by 'ntime').
                      A 'poly' fit is a robust piece-wise polynomial fit across the timerange.
                      Note: A robust fit is computed in upto 5 iterations. At each iteration, the stddev
                                between the data and the fit is computed, values beyond N-stddev are flagged,
                                and the fit and stddev are re-calculated with the remaining points.
                                This stddev calculation is adaptive, and converges to a value that reflects 
                                only the data and no RFI.  It also provides a varying set of flagging thresholds,
                                that allows deep flagging only when the fit represents the true data best.
                      Choose 'poly' only if the visibilities are expected to vary significantly over the
                      timerange selected by 'ntime', or if there is a lot of strong but intermittent RFI.

               freqfit -- Fitting function for the frequency direction
                    default: 'poly'
                    options: 'line','poly'
                        Same as for the 'timefit' parameter.
                        Choose 'line' only if you are operating on bandpass-corrected data, or residuals, 
                        and expect that the bandshape is linear. The 'poly' option works better when there
                        are multiple lines of strong narrow-band RFI. 

               maxnpieces -- Maxinum number of pieces to allow in the piecewise-polynomial fits 
                    default: 7
                    options: 1 - 9
                        This parameter is used only if 'timefit' or 'freqfit' are chosen as 'poly'.
                        If there is significant broad-band RFI, reduce this number. Using too many
                        pieces could result in the RFI being fitted in the 'clean' bandpass.    
                        In later stages of the fit, a third-order polynomial is fit per piece, so 
                        for best results, please ensure that nchan/maxnpieces is at-least 10.

               flagdimension -- Choose the directions along which to perform flagging
                    default: 'freqtime'; first flag along frequency, and then along time 
                                           (Step (3) followed by (1),(2))
                    options: 'time', 'freq', 'timefreq', 'freqtime'
                         For most cases, 'freqtime' or 'timefreq' are appropriate, and differences
                         between these choices are apparant only if RFI in one dimension is 
                         significantly stronger than the other. The goal is to flag the dominant RFI first.
                         If there are very few (less than 5) channels of data, then choose 'time'.
                         Similarly for 'freq'.

               usewindowstats -- Use sliding-window statistics to find additional flags.
                    default: 'none' 
                    options: 'none', 'sum', 'std', 'both'   
                         Note: This is experimental !
                           The 'sum' option chooses to flag a point, if the mean-value in a 
                           window centered on that point deviates from the fit by more than
                           N-stddev/2.0. 
                         Note: stddev is calculated between the data and fit as explained in Step (2).
                            This option is an attempt to catch broad-band or 
                            time-persistent RFI  that the above polynomial fits will mistakenly fit
                            as the clean band. It is an approximation to the sumThreshold
                            method found to be effective by Offringa et.al (2010) for LOFAR data. 
                            The 'std' option chooses to flag a point, if the 'local' stddev calculated
                            in a window centered on that point is larger than N-stddev/2.0. 
                            This option is an attempt to catch noisy RFI that is not excluded in the
                            polynomial fits, and which increases the global stddev, and results in 
                            fewer flags (based on the N-stddev threshold). This is an approximation to
                            the idea behind 'rflag' in AIPS (which E.Greisen is currently refining).
                                                                
                halfwin -- Half width of sliding window to use with 'usewindowstats'
                    default: 1  (a 3-point window size)
                    options: 1,2,3
                        Note: This is experimental !

            rflag -- Detect outliers based on a sliding-window RMS.
            
                     The rflag algorithm was originally developed by Eric Greisen in AIPS (31DEC11).
                     AIPS documentation : 
                     Task parameters : http://www.aips.nrao.edu/cgi-bin/ZXHLP2.PL?RFLAG
                     Summary : Section E.5 of the AIPS cookbook
                     (Appendix E : Special Considerations for EVLA data calibration and imaging in AIPS,
                     http://www.aips.nrao.edu/cook.html#CEE )
                     
                winsize -- 
                    default: 3
                    
                timedev --
                    default: []
                    
                freqdev --
                    default: []

                timedevscale --
                    default: 5.0
                    
                freqdevscale --
                    default: 5.0

                spectralmax -- 
                    default: 1E6
                    
                spectralmin --
                    default: 0.0


            extend -- Extend and/or grow flags beyond what the basic algorithms detect.
                            This mode will extend the accumulated flags available in the MS,
                            regardless of which algorithm created them.

                ntime -- Timerange (in seconds or minutes) over which to accumulate data before running the algorithms. 
                     options: 'scan' or any other float value or string containing the units.
                     default: 'scan'
                     example: '1.5min'
                            : 1.2 (taken in seconds)
                        The dataset will be iterated through in time-chunks defined here.
                
                combinescans -- accumulate data across scans.
                      default: False
                          It only makes sense when ntime not equal 'scan'.                

                extendpols -- Extend flags to all correlations
                      default: True
                      options: True/False
                growtime -- For any channel, flag the entire timerange in the current 2D chunk (set by 'ntime')
                             if more than X% of the timerange is already flagged.
                      default: 90.0
                      options: 0.0 - 100.0
                         This option catches the low-intensity parts of time-persistent RFI.

                growfreq -- For any timestep, flag all channels in the current 2D chunk (set by data-selection)
                            if more than X% of the channels are already flagged.
                      default: 90.0
                      options: 0.0 - 100.0
                         This option catches broad-band RFI that is partially identified by earlier steps.

                growaround -- Extend flags to immediately surrounding points in the time-freq plane.
                      default: False
                      options: True/False
                            For every un-flagged point on the 2D time/freq plane, if more than four
                            surrounding points are already flagged, flag that point. 
                            This option catches some wings of strong RFI spikes.

                flagneartime -- Flag points before and after every flagged one, in the time-direction.
                      default: False
                      options: True/False
                            Note: This can result in excessive flagging.

                flagnearfreq -- Flag points before and after every flagged one, in the frequency-direction
                            default: False
                            options: True/False
                            This option allows flagging of wings in the spectral response of strong RFI.
                            Note: This can result in excessive flagging.


            unflag -- Unflag according to the data selection specified.

            summary -- List the number of rows and data points flagged.
                  
                minrel -- Minimum number of flags (relative) to include in histogram
                    default: 0.0

                maxrel -- Maximum number of flags (relative) to include in histogram
                    default: 1.0

                minabs -- Minimum number of flags (absolute, inclusive) to include in histogram
                    default: 0

                maxabs -- Maximum number of flags (absolute, inclusive) to include in histogram
                          To indicate infinity, use any negative number.
                    default: -1

                spwchan -- list the number of flags per spw and per channel.
                    default: False

                spwcorr -- list the number of flags per spw and per correlation.
                    default: False

                basecnt -- list the number of flags per baseline
                    default: False

                    In this mode, the task returns a dictionary of flagging statistics.
                    Example:

                        s = tflagdata(..., mode='summary')

                     Then s will be a dictionary which contains
                    s['total']                  : total number of data
                    s['flagged']                : amount of flagged data
        

        run -- Run the task to produce flags or not. 
               default: True
               options: True/False
                    When set to False, the underlying tool will not be executed and no
                    flags will be produced. No data selection will be done either. This
                    is useful when used together with parameter savepars to only save the
                    current parameters (or list of parameters) to the FLAG_CMD sub-table or
                    to an external file. 

              writeflags -- Choose whether or not to write flags to the MS 
                   default: True
                   options: True/False
                        The tflagdata task can be run in 'writeflags=False' mode just to inspect the data,
                        or to try different parameters and converge on a set that works for a particular
                        dataset. Use the display parameter to inspect the data.
                    Note: this parameter is disabled when mode='summary'.
                 
              display -- Display data and/or end-of-MS reports at runtime.        
               	   default: 'none'
               	   options: 'none', 'data', 'report', 'both'

                  	 'data' --> display data and flags per-chunk at run-time, within an interactive GUI.

                      This option opens a GUI to show the 2D time-freq planes of
                      the data with old and new flags, for all correlations per baseline.
                      -- The GUI allows stepping through all baselines (prev/next) in
                      the current chunk (set by 'ntime'), and stepping to the next-chunk.
                      -- The 'tflagdata' task can be quit from the GUI, in case it becomes
                      obvious that the current set of parameters is just wrong.
                      -- There is an option to stop the display but continue flagging.

                  	'report' --> displays enf-of-MS reports on the screen.

                  	'both' --> displays data per chunk and end-of-MS reports on the screen
                                 
              flagbackup -- Automatically backup flags before running the tool.
                   default: True
                   options: True/False                    

        savepars -- Save the current parameters to the FLAG_CMD table of the MS or to an output text file.
                default: False
                options: True/False
                
                outfile -- Name of output file to save the current parameters.
                    default: ' '; it will save the parameters in the FLAG_CMD table of the MS.
                    example: outfile='flags.txt' will save the parameters in a text file.
                    
    
   ---- EXAMPLES ----
        
        1) Manually flag scans 1~3 and save the parameters to the FLAG_CMD sub-table.
        
            tflagdata('my.ms', scan='1~3, mode='manual', savepars=True)
            
        2) Append the parameters to a file.
    
            tflagdata('my.ms', scan='1~3, mode='manual', savepars=True, outfile='flags.txt')
            
        3) Flag all commands from the list given in flags.txt.
        
        cat flags.txt
        scan='1~3' mode='manual'
        spw='9' mode='tfcrop' correlation='ABS_RR,LL' ntime=51.0
        mode='extend' extendpols=True
        
            tflagdata('my.ms', mode='list', inpfile='flags.txt')

        4) Display the data and flags per-chunk and do not write flags to the MS.
        
            tflagdata('my.ms', mode='list', inpfile='flags.txt', writeflags=False, display='data')
            
        5) Flag all the antennas except antenna=5.
        
            tflagdata(vis='my.ms', antenna='!5', mode='manual)
            
        6) Clip the NaN in the data. An empty clipminmax will flag only NaN.
        
            tflagdata(vis=self.vis, mode='clip')
            
        7) Clip only the water vapour radiometer data.
        
            tflagdata(vis='my.ms',mode='clip',clipminmax=[0,50], correlation='ABS WVR')

		8) Clip only zero-value data.

            tflagdata(vis='my.ms',mode='clip',clipzeros=True)
            
        9) Flag only auto-correlations.
           
            tflagdata(vis=self.vis, mode='manual', antenna='*&amp;&amp;&amp;')
            
        10) Flag based on selected reasons from a file.
           
        cat flags.txt
        scan='1~3' mode='manual' reason='MYREASON'
        spw='9' mode='clip' clipzeros=True reason='CLIPZEROS'
        mode='manual' scan='4' reason='MYREASON'
            
            tflagdata(vis=self.vis, mode='list', inpfile='flags.txt', reason='MYREASON')
            

   ---- SYNTAX FOR COMMANDS GIVEN IN A FILE ----

        Basic Syntax Rules
        
          Commands are strings (which may contain internal "strings") consisting of
          KEY=VALUE pairs separated by whitespace. 

          NOTE: There should be no whitespace between KEY=VALUE or within each KEY or 
          VALUE, since the simple parser first breaks command lines on whitespace, 
          then on "=". 

          Use only white spaces to separate the parameters (no commas).
        
          Each key should only appear once on a given command line/string.
        
          There is an implicit "mode" for each command, with the default
          being 'manual' if not given.

          Comment lines can start with '#' and will be ignored.

          Example:
        
          scan='1~3' mode='manual'
          # this line will ignored
          spw='9' mode='tfcrop' correlation='ABS_XX,YY' ntime=51.0
          mode='extend' extendpols=True
          scan='1~3,10~12' mode='quack' quackinterval=1.0
          


    
</example>


    </task>
</casaxml>
        
