<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet type="text/xsl" ?>
<casaxml xmlns="http://casa.nrao.edu/schema/psetTypes.html"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://casa.nrao.edu/schema/casa.xsd
      file:///opt/casa/code/xmlcasa/xml/casa.xsd">

<task type="function" name="flagdata" category="data editing">
        <shortdescription> All purpose flagging task based on selections</shortdescription>
        <description>
        The task will select a subset of data explicitly for flagging,
        quacking, clipping, and autocorrelation flagging, or flagging
        of shadowed antennas. Unflagging is also available.

        In a dual polarization data set, each polarization can be flagged
        separately.  However, at present the calibration and imaging will
        only use data with both parallel hands unflagged.

        There is a vector mode of operation to execute several flagging options
        in one execution.

        </description>
        <input>
                <param type="string" name="vis" mustexist="true">
                        <description>Name of file to flag</description>
                        <value></value>
                </param>

                <param type="string" name="mode">
                        <description>Mode (manualflag,shadow,quack,summary,autoflag,alma,rfi)</description>
                        <value>manualflag</value>
                        <allowed kind="enum">
                        <value>manualflag</value>
                        <value>autoflag</value>
                        <value>summary</value>
                        <value>quack</value>
                        <value>shadow</value>
                        <value>alma</value>
                        <value>rfi</value>
                        </allowed>
                </param>

                <param type="any" name="spw">
                        <description>spectral-window/frequency/channel</description>
                        <any type="variant" limittypes="string stringArray"/>
                        <value type="string"></value>
                </param>

                <param type="any" name="field">
                        <description>Field names or field index numbers: \'\'==>all, field=\'0~2,3C286\'</description>
                        <any type="variant" limittypes="string stringArray"/>
                        <value type="string"></value>
                </param>

                <param type="bool" name="selectdata">
                        <description>More data selection parameters (antenna, timerange etc)</description>
                        <value>True</value>
                </param>

                <param type="any" name="antenna" subparam="true">
                        <description>antenna/baselines: \'\'==>all, antenna = \'3,VA04\'</description>
                        <any type="variant" limittypes="string stringArray"/>
                        <value type="string"></value>
                </param>

                <param type="any" name="uvrange" subparam="true">
                        <description>uv range: \'\'==>all; uvrange = \'0~100klambda\', default units=meters</description>
                        <any type="variant" limittypes="string stringArray"/>
                        <value type="string"></value>
                </param>

                <param type="any" name="timerange" subparam="true">
                        <description>time range: \'\'==>all, timerange=\'09:14:0~09:54:0\'</description>
                        <any type="variant" limittypes="string stringArray"/>
                        <value type="string"></value>
                </param>

                <param type="any" name="correlation" subparam="true">
                        <description>Select data based on correlation</description>
                        <any type="variant" limittypes="string stringArray"/>
                        <value type="string"></value>
                </param>

                <param type="any" name="scan" subparam="true">
                        <description>scan numbers: \'\'==>all</description>
                        <any type="variant" limittypes="string stringArray"/>
                        <value type="string"></value>
                </param>

                <param type="any" name="feed" subparam="true">
                        <description>multi-feed numbers: Not yet implemented</description>
                        <any type="variant" limittypes="string stringArray"/>
                        <value type="string"></value>
                </param>

                <param type="any" name="array" subparam="true">
                        <description>(sub)array numbers: \'\'==>all</description>
                        <any type="variant" limittypes="string stringArray"/>
                        <value type="string"></value>
                </param>

                <param type="any" name="clipexpr" subparam="true">
                        <description>Expression to clip on</description>
                        <any type="variant" limittypes="string stringArray"/>
                        <value type="string">ABS RR</value>
                </param>

                <param type="any" name="clipminmax" subparam="true">
                        <description>Range to use for clipping</description>
                        <any type="variant" limittypes="doubleArray doubleArrayArray"/>
                        <value type="doubleArray"></value>
                </param>

                <param type="any" name="clipcolumn" subparam="true">
                        <description>Data column to use for clipping</description>
                        <any type="variant" limittypes="string stringArray"/>
                        <value type="string">DATA</value>
                         <!-- <allowed kind="enum">
                           <value>'DATA'</value>
                           <value>'CORRECTED'</value>
                           <value>'MODEL'</value>
                        </allowed> -->
                </param>

                <param type="any" name="clipoutside" subparam="true">
                        <description>Clip outside the range, or within it</description>
                        <any type="variant" limittypes="bool boolArray"/>
                        <value type="bool">True</value>
                </param>

                <param type="any" name="quackinterval" subparam="true">
                        <description>Quack n seconds from scan beginning</description>
                        <any type="variant" limittypes="double doubleArray"/>
                        <value type="double">0.0</value>
                </param>

                <param type="any" name="autocorr" subparam="true">
                        <description>Flag autocorrelations</description>
                        <any type="variant" limittypes="bool boolArray"/>
                        <value type="bool">False</value>
                </param>

                <param type="any" name="unflag" subparam="true">
                        <description>Unflag the data specified</description>
                        <any type="variant" limittypes="bool boolArray"/>
                        <value type="bool">False</value>
                </param>

                <param type="string" name="algorithm" subparam="true">
                        <description>Autoflag algorithm (timemed,freqmed)</description>
                        <value>timemed</value>
                        <allowed kind="enum">
                        <value>timemed</value>
                        <value>freqmed</value>
                        </allowed>
                </param>

                <param type="string" name="recipe" subparam="true">
                        <description>Flagging algorithm (pdb_recipe,vla_recipe)</description>
                        <value>vla_recipe</value>
                        <allowed kind="enum">
                        <value>pdb_recipe</value>
                        <value>vla_recipe</value>
                        </allowed>
                </param>

                <param type="string" name="column" subparam="true">
                        <description>Data column to operate on.</description>
                        <value>DATA</value>
                        <allowed kind="enum">
                        <value>DATA</value>
                        <value>CORRECTED</value>
                        <value>MODEL</value>
                        </allowed>
                </param>

                <param type="string" name="expr" subparam="true">
                        <description>Expression to flag on</description>
                        <value>ABS RR</value>
                </param>

                <param type="double" name="thr" subparam="true">
                        <description>Flagging threshold (n sigma)</description>
                        <value>5.0</value>
                </param>

                <param type="int" name="window" subparam="true">
                        <description>Sliding median filter width</description>
                        <value>10</value>
                </param>

                <param type="double" name="diameter" subparam="true">
                        <description>Effective diameter (m) to use. -1 ==>antenna diameter</description>
                        <value>-1.0</value>
                </param>

		<param type="string" name="flux" subparam="true">
			<description>Flux calibrator field index number: flux=\'0\'</description>
			<value></value>
		</param>
		<param type="string" name="bpass" subparam="true">
			<description>Bandpass calibrator field index number: bpass=\'0\'</description>
			<value></value>
		</param>
		<param type="string" name="gain" subparam="true">
			<description>Gain calibrator field index number: gain=\'0\'</description>
			<value></value>
                </param>


                <param type="double" name="time_amp_cutoff" subparam="true">
                        <description>Flagging thresholds in units of sigma, where sigma is the stdev of the "fit"</description>
                        <value>4.0</value>
                </param>
                <param type="double" name="freq_amp_cutoff" subparam="true">
                        <description>Flagging thresholds in units of sigma, where sigma is the stdev of the "fit"</description>
                        <value>3.0</value>
                </param>
                <param type="bool" name="freqlinefit" subparam="true">
                        <description>Fit the bandpass with a straight line (True), or fit the bandpass with a piecewise polynomial (False)</description>
                        <value>False</value>
                </param>
                <param type="int" name="auto_cross" subparam="true">
                        <description>flag on cross-correlations and auto-correlations (0 : only autocorrelations)</description>
                        <value>1</value>
                </param>
                <param type="int" name="num_time" subparam="true">
                        <description>number of time-steps in each chunk</description>
                        <value>400</value>
                </param>
                <param type="int" name="start_chan" subparam="true">
                        <description>channel range start (1 based)</description>
                        <value>1</value>
                </param>
                <param type="int" name="end_chan" subparam="true">
                        <description>channel range end (1 based)</description>
                        <value>2048</value>
                </param>
                <param type="double" name="bs_cutoff" subparam="true">
                        <description>baseline tolerance</description>
                        <value>0.0</value>
                </param>
                <param type="double" name="ant_cutoff" subparam="true">
                        <description>total autocorrelation amplitude threshold for a functional antenna</description>
                        <value>0.0</value>
                </param>
                <param type="bool" name="showplots" subparam="true">
                        <description>Show plots of each time-frequency chunk</description>
                        <value>False</value>
                </param>
                <param type="int" name="flag_level" subparam="true">
                        <description>0: flag only what is found. 1: extend flags one timestep before and after. 2: extend flags one timestep and channel before/after</description>
                        <value>1</value>
                </param>

                <constraints>
                        <when param="mode">
                                <equals value="manualflag">
                                        <default param="autocorr"><value type="bool">False</value></default>
                                        <default param="unflag"><value type="bool">False</value></default>
                                        <default param="clipexpr"><value type="string">ABS RR</value></default>
                                        <default param="clipminmax"><value type="doubleArray"></value></default>
                                        <default param="clipcolumn"><value type="string">DATA</value></default>
                                        <default param="clipoutside"><value type="bool">True</value></default>
                                </equals>
                                <equals value="autoflag">
                                        <default param="algorithm"><value type="string">timemed</value></default>
                                        <default param="column"><value type="string">DATA</value></default>
                                        <default param="expr"><value type="string">ABS RR</value></default>
                                        <default param="thr"><value type="double">5.0</value></default>
                                        <default param="window"><value type="int">10</value></default>
                                </equals>
                                <equals value="quack">
                                        <default param="autocorr"><value type="bool">False</value></default>
                                        <default param="unflag"><value type="bool">False</value></default>
                                        <default param="quackinterval"><value type="double">0.0</value></default>
                                </equals>
                                <equals value="summary"/>
                                <equals value="shadow">
                                        <default param="diameter"><value type="double">-1.0</value></default>
                                </equals>
                                <equals value="alma">
                                        <default param="recipe"><value type="string">vla_recipe</value></default>
                                        <default param="flux"><value type="string"></value></default>
                                        <default param="gain"><value type="string"></value></default>
                                        <default param="bpass"><value type="string"></value></default>
                                </equals>
                                <equals value="rfi">
                                        <default param="clipcolumn"><value type="string">DATA</value></default>
                                        <default param="clipexpr"><value type="string">ABS RR</value></default>
                                        <default param="time_amp_cutoff"><value type="double">4.0</value></default>
                                        <default param="freq_amp_cutoff"><value type="double">3.0</value></default>
                                        <default param="freqlinefit"><value type="bool">False</value></default>
                                        <default param="auto_cross"><value type="int">1</value></default>
                                        <default param="num_time"><value type="int">400</value></default>
                                        <default param="start_chan"><value type="int">1</value></default>
                                        <default param="end_chan"><value type="int">2048</value></default>
                                        <default param="bs_cutoff"><value type="double">0.0</value></default>
                                        <default param="ant_cutoff"><value type="double">0.0</value></default>
                                        <default param="showplots"><value type="bool">False</value></default>
                                        <default param="flag_level"><value type="int">1</value></default>
                                </equals>
                        </when>
                        <when param="selectdata">
                                <equals type="bool" value="True">
                                        <default param="antenna"><value type="string"></value></default>
                                        <default param="timerange"><value type="string"></value></default>
                                        <default param="correlation"><value type="string"></value></default>
                                        <default param="scan"><value type="string"></value></default>
                                        <default param="feed"><value type="string"></value></default>
                                        <default param="array"><value type="string"></value></default>
                                        <default param="uvrange"><value type="string"></value></default>
                                </equals>
                                <equals type="bool" value="False"/>
                        </when>
                </constraints>
        </input>
<returns type="void"/>

<example>
        The task will flag a subset of data explicitly with the modes:
            manualflag = flagging based on specific selection parameter
                         plus clipping and flagging autcorrelations
            summary    = report the amount of flagged data
            quack      = remove specific time range at scan beginning
            shadow     = remove antenna-shadowed data
            alma       = ALMA pipeline auto-flagging
            rfi        = Radio Frequency Interference auto-flagging
            autoflag   = experimental auto-flagging outliers

        Unflagging is also available with all options (except shadowing)

        Note: I a dual polarization data set, each polarization can be flagged
        separately.  However, at present the calibration and imaging will
        only use only data with both parallel hands unflagged.

        Keyword arguments:
        vis -- Name of input visibility file
                default: none example: vis='ngc5921.ms'
        mode -- Mode of operation.
                options: 'manualflag','autoflag','summary','quack','shadow','alma'
                default: 'manualflag'

        manualflag --  option does data-selected flagging.
               If autocorr = F; clipminmax = [], then
                  flagging or unflagging [unflag=F, unflag=T] is specified by
                  the data selection parameters.
                     
           Other flagging options, with the appropriate data selection
           parameters, that are available are:

              autocorr -- Flag autocorrelations 
                  default: False
                  options: True,False

              clipexpr -- Clip using the following:
                default: 'ABS RR'; example: clipexpr='RE XX'
                Options: 'ABS','ARG','RE','IM','NORM' + ' ' +
                          'I','XX','YY','RR','LL'
              clipminmax -- Range of data (Jy) that will NOT be flagged
                default: [] means do not use clip option
                example: [0.0,1.5]
              clipcolumn -- Column to use for clipping.
                default: 'DATA'
                options: 'DATA','CORRECTED','MODEL'
              clipoutside -- Clip OUTSIDE the range ?
                default: True
                example: False -&gt; flag data WITHIN the range.
              unflag -- Unflag the specified data
                default: False (i.e. flag); example: unflag=True
              
        quack: option to remove specified part of scan beginning
           quackinterval -- Time in seconds from scan beginning to flag
                Make time slightly small than desired time
           unflag -- Unflag the data
                default =&gt; False (quack as indicated)
                           True (unquack)
           autocorr -- Flag autocorrelations (independent option)
                default =&gt; False

        shadow: option to flag data of shadowed antennas
           diameter -- effective diameter to use when determining if an antenna
                    is shadowed at a given time stamp. The given value is used
                    for all antennas. If this is set to a negative number
                    (default), the actual antenna diameters are used.

        summary: lists number of rows and data points flagged
           No subparameters

        autoflag: experimental automatic flagging of outliers.
           It is still under development
           algorithm -- autoflag algorithm name
                default: 'timemed'
                options: 'timemed','freqmed'
           column -- the column on which to operate (DATA, CORRECTED, MODEL)
           expr -- expression to use for flagging option
                default: 'ABS RR'; example: expr='RE XX'
                Options: 'ABS','ARG','RE','IM','NORM' + ' ' +
                     'I','XX','YY','RR','LL'
           thr -- flagging threshold as a multiple of standard-deviation ( n sigma )
           window -- half width for sliding window median filters.  The size should be
                  about the number of integration in a scan, or the number of
                  spectral channels.

        rfi: RFI automatic flagging of outliers.
           For more information, see ???

           clipcolumn -- the column on which to operate (DATA, CORRECTED, MODEL)
           clipexpr -- expression to use for flagging option
                default: 'ABS RR'; example: expr='RE XX'
                Options: 'ABS','ARG','RE','IM','NORM' + ' ' +
                     'I','XX','YY','RR','LL'

        alma: Automatic flagging algorithm from the ALMA heuristics pipeline.
           For more information, see ???
           Note: selection parameters are *not* used in this mode. The algorithm
           always run on the full MS.

           recipe -- which algorithm to use
                default: 'vla_recipe'
                options: 'vla_recipe', 'pdb_recipe' 
           flux -- which field to use as flux calibrator
           bpass -- which field to use as bandpass calibrator
           gain -- which field to use as gain calibrator


        selectdata -- Other data selection parameters
                default: True
        antenna -- Select data based on baseline
                default: '' (all); example: antenna='5&amp;6' baseline 5-6
                antenna='5&amp;6;7&amp;8' #baseline 5-6 and 7-8
                antenna='5' # all baselines with antenna 5
                antenna='5,6' # all baselines with antennas 5 and 6
        spw -- Select data based on spectral window and channels
                default: '' (all); example: spw='1'
                spw='&lt;2' #spectral windows less than 2
                spw='&gt;1' #spectral windows greater than 1
                spw='0:0~10' # first 10 channels from spw 0
                spw='0:0~5;56~60' # multiple separated channel chunks.
        correlation -- Correlation types
                default: '' (all);
                example: correlation='RR LL'
        field -- Select data based on field id(s) or name(s)
                default: '' (all); example: field='1'
                field='0~2' # field ids inclusive from 0 to 2
                field='3C*' # all field names starting with 3C
        uvrange -- Select data within uvrange (default units meters)
                default: '' (all); example:
                uvrange='0~1000klambda'; uvrange from 0-1000 kilo-lamgda
                uvrange='&gt;4klamda';uvranges greater than 4 kilo-lambda
                uvrange='0~1000km'; uvrange in kilometers
        timerange  -- Select data based on time range:
                default = '' (all); example,
                timerange = 'YYYY/MM/DD/hh:mm:ss~YYYY/MM/DD/hh:mm:ss'
                Note: YYYY/MM/DD can be dropped as needed:
                timerange='09:14:0~09:54:0' # this time range
                timerange='09:44:00' # data within one integration of time
                timerange='&gt;10:24:00' # data after this time
                timerange='09:44:00+00:13:00' #data 13 minutes after time
        scan -- Select data based on scan number
                default: '' (all); example: scan='&gt;3'
        feed -- Selection based on the feed - NOT IMPLEMENTED YET
        array -- Selection based on the antenna array

        -- Vector mode --

        For reasons of performance (to reduce the number loops through the MS),
        several flagdata task invocations can be combined into a single
        flagdata() run by giving vectors of parameters. 

        This is possible for the modes 'manualflag' and 'quack', only.

        For example, the following three flagdata runs:

            vis = 'my.ms'
            mode = 'manualflag'
            selectdata = True
            flagdata(vis='my.ms', mode='manualflag', field='3', autocorr=True)
            flagdata(vis='my.ms', mode='manualflag', field='3', timerange = '6:0:0~6:23:00')
            flagdata(vis='my.ms', mode='manualflag', field='3', scan='0', spw='0:60;62;64')

        can be combined into a single run by:

            vis = 'my.ms'
            mode = 'manualflag'
            selectdata = True

            field     = '3'
            spw       = [ ''   , ''            , '0:60;62:64' ]
            autocorr  = [ True , False         , False        ]
            timerange = [ ''   , '6:0:0~6:23:0', ''           ]
            scan      = [ ''   , ''            , '0'          ]

            flagdata()

        Note that field='3' is equivalent to field=['3','3','3']
 </example>
 </task>
 </casaxml>
