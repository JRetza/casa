%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% STM 2007-04-13  split from previous version
% STM 2007-08-24  quick update
% DK  2007-10-10  beta release
% STM 2007-10-10  spell-check
% DK  2007-10-11  update
% DK  2007-10-12  update
% DK  2008-10-02  update patch3
% JO 2010-03-03 updates for 3.0.1
% JO 2011-10-08  Release 3.3.0 edits
% JO 2011-05-09  Release 3.4 edits and Harald Kuemmel edits. 
% JO 2012-10-24  Release 4.0 edits

\chapter{Visualization With The CASA Viewer}
\label{chapter:display}

This chapter describes how to display data with the {\tt casaviewer}
either as a stand-alone or through the {\tt viewer} task. You can
display both images and Measurement Sets in the viewer. We are
in the process of splitting the task-level access to the viewer into 
two different tasks {\tt imview} for images and {\tt msview} for measurement 
sets. These tasks offer improved functionality in the form of command
line access to many of the viewer features. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Starting the {\tt viewer}}
\label{section:display.start}

\begin{figure}[h!]
\begin{center}
\pngname{viewer-start}{5}
%\pngname{viewer_n5921_1}{4.3}
%\pngname{viewer_n5921_2}{2.1}
\caption{\label{fig:viewer_start} The {\bf Viewer Display Panel} (left) and 
the {\bf Data Display Options} (right) panel for a regular image or data cube.}
\hrulefill
\end{center}
\end{figure}

Within the casapy environment, the {\tt viewer} task
can be used to display an image or MS.  The inputs are:
\small
\begin{verbatim}
#  viewer :: View an image or visibility data set.

infile        =         ''   #   (Optional)  Name of file to visualize.
displaytype   =   'raster'   #   (Optional)  Type of visual rendering
                             #   (raster, contour, vector or marker).
                             #   lel  if an lel expression is given
                             #   for infile (advanced).

\end{verbatim}
\normalsize

Examples of starting the {\tt viewer}:
\small
\begin{verbatim}
  CASA <1>: viewer()

  CASA <2>: viewer('ngc5921.demo.ms')

  CASA <3>: viewer('ngc5921.demo.cleanimg.image')

  CASA <4>: viewer('ngc5921.demo.cleanimg.image', 'contour')
  
  CASA <5>: viewer('"ngc5921.demo.cleanimg.image"^2', 'lel')
\end{verbatim}
\normalsize

The first of these creates an empty {\bf Viewer Display Panel} 
(\S~\ref{section:display.viewerGUI.displaypanel}) and a {\bf Load Data} 
window (\S~\ref{section:display.dataManager.load}) .  The second starts the
{\tt viewer} loaded with a Measurement Set.  The third example
starts the {\tt viewer} with an image cube (see Figure~\ref{fig:viewer_start}).  

%Example four brings up a display panel as it was when its state was saved
%to the given 'restore' file ({\tt ngc5921.usecase.clean.image.rstr}).
%This includes the data displayed as well as options and viewer
%settings.  (See \S~\ref{section:display.viewerGUI.save-restore},
%{\bf Saving and Restoring Viewer State}).

Examples four and five make use of the second parameter ({\tt displaytype}).  Example 
four displays the image in contour form.  Example five uses 'Lattice (Image) Expression 
Language' to display the square of the image data.

{\bf NOTE:} the viewer determines file types (images, MSs, restore files) automatically.  
It is not necessary to specify, e.g., {\tt filetype='ms'} explicitly.

The CASA  viewer consists of a number of graphical user interface (GUI) windows.
The main {\bf Viewer Display Panel} (\S~\ref{section:display.viewerGUI.displaypanel})
is used for both image and Measurement Set viewing and we describe it first. The
{\bf Data Manager Panel} (\S~\ref{section:display.dataManager}) is used to load images, 
Measurement Sets, and Display Panel States and to save regions and images. Most
other windows are context specific and we describe these in the sections on viewing
images (\S~\ref{section:display.image}) and Measurement Sets (\S~\ref{section:display.ms}).

\begin{figure}[h!]
\begin{center}
\pngname{viewer-start-ms}{5}
\pngname{viewer_n5921ms_1}{4.3}
\pngname{viewer_n5921ms_2}{2.1}
\caption{\label{fig:viewer_start_ms} The {\bf Viewer Display Panel}
(left) and {\bf Data Display Options} (right) panels with a Measurement Set open.} 
\hrulefill
\end{center}
\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Running the CASA viewer outside {\tt casapy}}
\label{section:display.start.casaviewer}

If you have CASA installed, then the CASA viewer is available as a
stand-alone application called {\tt casaviewer}.  From the operating system prompt,
the following commands are equivalent to the {\tt casapy} task commands
given in the previous Section:

\small
\begin{verbatim}
  casaviewer &
  
  casaviewer ms_filename &
  
  casaviewer image_filename &
  
  %casaviewer restore_filename &
  
  casaviewer image_filename contour &
  
  casaviewer '"image_filename"^2' lel &
\end{verbatim}
\normalsize

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{The Viewer Display Panel}
\label{section:display.viewerGUI.displaypanel}

% \begin{figure}[h!]
% \gname{viewer0}{4}
% \caption{\label{fig:viewer0} Viewer Display Panel with no data
%   loaded. Each section of the GUI is explained below} 
% \hrulefill
% \end{figure}
 
The Viewer Display Panel displays the image or Measurement Set. It is shown in the left panels of 
Figures~\ref{fig:viewer_start} and \ref{fig:viewer_start_ms} and appears the same whether an image 
or Measurement Set is being displayed.
 
At the top of the Viewer Display Panel are dro-down menus:

\begin{itemize}
\item {\bf Data}
  \begin{itemize}
      \item  {\tt Open} --- choose a data file to load and display
      \item  {\tt Register} --- select/de-select the (previously-loaded)
             data file(s) which should display right now (menu expands
	     to the right showing all loaded data) 
      \item  {\tt Close} --- close (unload) selected data file (menu
             expands to the right)
      \item  {\tt Adjust} --- open the Data Display Options ('Adjust') panel 
      \item  {\tt Save as...} --- save/export data to a file
      \item  {\tt Print} --- print the displayed image
      \item  {\tt Save Panel State} --- to a 'restore' file (xml format)
      \item  {\tt Restore Panel State} --- from a restore file
      \item  {\tt Preferences} --- manually edit the viewer configuration
      \item  {\tt Close Panel} --- close the Viewer Display Panel (will exit
             if this is the last display panel open)
      \item  {\tt Quit Viewer} --- close all display panels and exit
  \end{itemize}
\item {\bf Display Panel}
  \begin{itemize}
      \item {\tt New Panel} --- create a new, empty Viewer Display Panel
      \item {\tt Panel Options} --- open the Display Panel's options window
      \item  {\tt Save Panel State}
      \item  {\tt Restore Panel State}
      \item {\tt Print} --- print displayed image
      \item {\tt Close Panel} --- close the Viewer Display Panel (will exit if
            this is the last display panel open)
  \end{itemize}
\item {\bf Tools}
  \begin{itemize}
      \item {\tt Spectral Profile} --- plot intensity vs. frequency for part of an image
       \item {\tt Collapse Image} --- create moment maps by integrating along the spectral axis
  \end{itemize}
\item {\bf View}
  \begin{itemize}
      \item {\tt Main Toolbar} --- show/hide the top row of icons (Figure \ref{fig:viewer_maintoolbar}
      \item {\tt Mouse Toolbar} --- show/hide the second row of mouse-button action selection icons
      \item {\tt Animator} --- show/hide tapedeck control panel attachment
      \item {\tt Position Tracking} --- show/hide the position tracking attachment 
      \item {\tt Regions} --- show/hide the region manager attachment
  \end{itemize}
\end{itemize}

\subsection{The Main Toolbar}

\begin{figure}[h!]
\begin{center}
\pngname{viewer_maintoolbar}{5}
\caption{\label{fig:viewer_maintoolbar} The display panel's
{\bf Main Toolbar} appears directly below the menus and contains
'shortcut' buttons for most of the frequently-used menu items.}
\hrulefill
\end{center}
\end{figure}

Below the drop down menus is the {\bf Main Toolbar} (Figure~\ref{fig:viewer_maintoolbar}).
This top row of icons offers fast access to these menu items:
\begin{itemize}
   \item {\bf folder} ({\tt Data:Open} shortcut) --- show the Load Data panel
   \item {\bf wrench} ({\tt Data:Adjust} shortcut) --- show the Data Display
              Options ('Adjust') panel 
   \item {\bf panels} ({\tt Data:Register} shortcut) --- show the 
              menu of loaded data
   \item {\bf delete} ({\tt Data:Close} shortcut) --- closes/unloads 
              selected data
   \item {\bf save data} ({\tt Data:Save as}) --- save/export data to a file
   \item {\bf new panel} ({\tt Display Panel:New Panel})
   \item {\bf panel wrench} ({\tt Display Panel:Panel Options}) --- show
              the Display Panel's options window 
   
   \item  {\bf save panel} ({\tt Display Panel: Save Panel State}) -- save panel state to a 'restore' file
   \item  {\bf restore panel} ({\tt Display Panel: Restore Panel State}) -- restore panel state from a restore file
   \item  {\bf profile panel} ({\tt Tools: Spectral Profile}) -- open the spectral profiler
   \item  {\bf collapse panel}({\tt Tools: Collapse Image}) -- open the image collapse panel
  % \item {\bf region save} ({\tt Tools:Region Manager}) --- save/control   
   \item {\bf print} ({\tt Display Panel:Print}) --- print data
   \item {\bf magnifier box} --- zoom out all the way
   \item {\bf magnifier plus} --- zoom in (by a factor of 2)
   \item {\bf magnifier minus} --- zoom out (by a factor of 2)
\end{itemize}

\subsection{The Mouse Toolbar}

\begin{figure}[h!]
\begin{center}
\pngname{viewer_mousetoolbar}{3}
\caption{\label{fig:viewer_mousetoolbar} The 
{\bf 'Mouse Tool' Bar} allows you to assign how mouse buttons behave in 
the image display area.  Initially, zooming, color adjustment, and rectangular 
regions are assigned to the left, middle and right mouse buttons. Click on a tool
with a mouse button to assign that tool to that mouse button.}
\hrulefill
\end{center}
\end{figure}

Below the Main Toolbar are ten {\bf Mouse Tool} buttons
(Figure~\ref{fig:viewer_mousetoolbar}). These allow you to assign
what behavior the three mouse buttons have when clicked in the display area. Clicking a mouse 
tool icon will [re-]assign the mouse button that was clicked to that tool. 
Black and white squares beneath the icons show which mouse button is currently
assigned to which tool.  

The mouse tools available from the toolbar are:

({\em Note that the 'escape' key can be used to cancel any mouse tool operation that was
begun but not completed, and to erase a region, point, or other tool showing in the display area.})

\begin{itemize}
   \item {\bf Zooming (magnifying glass icon):}
     To zoom into a selected area, press the Zoom tool's mouse button
     (the {\bf left} button by default) on one corner of the desired
     rectangle and drag to the desired opposite corner. Once the button is
     released, the zoom rectangle can still be moved or resized by dragging.
     To complete the zoom, double-click inside the selected rectangle. If you
     instead double-clicking {\it outside} the rectangle, you will zoom {\it out}.
   \item {\bf Panning (hand icon):} Press the tool's mouse button on a 
     point you wish to move, drag it to the position where you want it
     moved, and release. {\it Note: The arrow keys, Page Up, Page Down,
     Home and End keys can also be used to pan through your data any time
     you are zoomed in. (Click on the main display area first, to be sure
     the keyboard is 'focused' there).}
   \item {\bf Stretch-shift colormap fiddling (crossed arrows):} This is
     usually the handiest color adjustment; it is assigned to the {\bf middle}
     mouse button by default.
   \item {\bf Brightness-contrast colormap fiddling (light/dark sun)} 
   \item {\bf Positioning (plus):} This tool can place a point
     marker on the display to select a position. It is used to flag
     Measurement Set data or to select an image position for spectral
     profiles.  Click on the desired position with the tool's mouse
     button to place the point; once placed you can drag it to other
     locations. You can also place multiple points on the display
     (e.g. for different spectral profile positions) -- remove them by
     hovering over and hitting {\tt ESC}.  Double-click is not needed
     for this tool.  See
     \S~\ref{section:display.viewerGUI.displaypanel.region} for more
     detail.
   \item {\bf Rectangle, Ellipse and Polygon region drawing:} The rectangle
     region tool is assigned to the {\bf right} mouse button by default.
     As with the zoom tool, a rectangle region is generated by dragging with
     the assigned mouse button; the selection is confirmed by double-clicking
     within the rectangle.
     An ellipse regions is created by dragging with the assigned mouse button.
     In addition to the elliptical region, also its surrounding rectangle is
     shown on the display. The selection is confirmed by double-clicking within
     the ellipse.
     Polygon regions are created by clicking the assigned mouse button
     at the desired vertices, clicking the final location twice to finish.
     Once created, a polygon can be moved by dragging from inside, or
     reshaped by dragging the handles at the vertices. 
     See \S~\ref{section:display.viewerGUI.displaypanel.region} for the uses
     of this tool.
   \item {\bf Polyline drawing:}
     A polyline can be created by selecting this tool. It is manipulated
     similarly to the polygon region tool: create segments by clicking at
     the desired positions and then double-click to finish the line.
     [Uses for this tool are still to be implemented].
   \item {\bf Distance tool:}
     After selecting the distance tool by assigning any mouse button to it,
     distances on the image can conveniently be measured by dragging the
     mouse with the assigned button pressed. The tool measures the distances
     along the world coordinate axes and along the hypotenuse. If the units
     in both axes are $[deg]$, the distances are displayed in $[arcsec]$.
\end{itemize}

\subsection{Display Area}

The main {\bf Display Area} lies below the toolbars. This area shows
the image or Measurement Set currently loaded. Clicking the mouse inside
the display area allows region or position selection according to the settings
in the mouse toolbar.

The Display Area may have up to three attached panels: the {\bf
  Animator} panel, the {\bf Position Tracking} panel, and the {\bf
  Regions} panel. These appear on the right side of the image by
default but may be dragged to be attached to any side of the image or
"undocked" from the main display panel to act as separate
windows. Each of these attached panels can be turned off by clicking
the "X" in the top right corner or toggled via the drop down {\bf
  View} menu.

\subsubsection{Animator Panel}

The Animator Panel allows you to scroll through the channels of a data
cube or rotate among several loaded images. The main features of the
panel are the two ``tape decks''. The {\bf Channels} tape deck enables
movement between planes of an individual image. By default, the
channel tape deck scrolls among frequency planes when R.A. and
Declination are the displayed axes. The {\bf Images} tape rotates
which is being displayed (among registered images), allowing one one
to 'blink' between images when more than a single image is loaded and
registered. If both "Channels" and "Images" is checked, then the
channel tape deck provides movement between image planes in {\it all}
loaded and registered images.  If the "Channels" is checked, but
"Images" is not, then the movement is between image planes of only a
single image.


From left to right, the tape deck controls allow the user to:
\begin{itemize}
   \item {\bf rewind} to the start of the sequence (i.e., the first plane)
   \item {\bf step backwards} by one plane
   \item {\bf play backwards}, or repetitively step backwards
   \item {\bf stop} any current play
   \item {\bf play forward}, or repetitively step forward
   \item {\bf step forward} by one plane
   \item {\bf fast forward} to the end of the sequence
\end{itemize}

To the right of each tape deck are two editable text boxes. The first indicates the
current frame (image) number number with a label showing the total number of
frames (images). To the right of this is a box that allows the user to set 
the 'Rate' or speed of the animation when "play" is clicked.

\subsubsection{Position Tracking Panel}

The {\bf Position Tracking} panel (below the images in Fig\,\ref{fig:viewer_start})
shows information such as intensity, position (e.g. RA and Dec), Stokes, frequency 
(or velocity), and pixel location for the point currently under the cursor.  A separate box
appears for each registered image or Measurement Set and you can see the
tracking information for each.  Tracking can be 'frozen' (and unfrozen again)
by hitting the space bar when the viewer's focus is on the main display area 
(to be sure that this is case first click on the main display area).

\subsubsection{Region Panel}

The 'Region' panel becomes active when regions
are created. We discuss this in \S\ref{section:display.image.rgnmgr}. It contains
information on the properties of the selected region and statistics within the region and
allows for fitting of the emission in the region and saving or loading of region files.

\subsubsection{Region Selection and Positioning in the Display Area}
\label{section:display.viewerGUI.displaypanel.region}

Within the display area, you you can draw regions or select positions using the mouse.
To do so, first select the appropriate tool(s) on the {\tt Mouse Toolbar}. The tools
work as follows.

The {\tt Rectangle Region} drawing tool currently works for the following: 
\begin{itemize}
  \item Region statistics reporting for images (via double clicking in the region or in the Regions panel),
  \item Defining a region to be average for the spectral profile tool (accessed via the {\tt Tools:Spectral Profile} drop down menu or "Open the Spectrum Profiler" icon),
  \item Flagging of Measurement Sets. Note that the {\tt Rectangle Region} tool's mouse button must also be double-clicked to confirm an MS flagging edit.
  \item Creating and saving an image region for various types of analysis (from the Regions panel, see \S~\ref{section:display.image.rgnmgr})
  \item Selecting Clean regions interactively (\S~\ref{section:im.clean.interactive})
\end{itemize}

The {\tt Polygon Region} and {\tt Ellipse Region} drawing have the same uses, except that polygon region
flagging of a Measurement Set is not supported.

The {\tt Positioning} tool works for the spectral profiler, flagging visibilities, and can be saved and loaded via the Regions panel. 
Flagging with the pointer responds to single click or drag.

Once a region is defined, mouse over it inside the main display area to bring it into focus in the Regions panel or Spectral Profile Tool.

{\em Region Statistics:} A variety of statistics for the currently region are displayed in the {\bf stats} tab of the Regions panel. These can
be printed to the terminal window (not the logger) by double-clicking the completed region with the left mouse button. Here is an example of 
reported region statistics:

\small
\begin{verbatim}
(IRC10216.36GHzcont.image) image
          Stokes         Velocity            Frame          Doppler        Frequency 
               I -2.99447e+11km/s             LSRK            RADIO      3.63499e+10 
  BrightnessUnit         BeamArea             Npts              Sum             Flux 
         Jy/beam          36.2521            27547     1.087686e-01     3.000336e-03 
            Mean              Rms          Std dev          Minimum          Maximum 
    3.948473e-06     3.723835e-04     3.723693e-04    -1.045624e-03     9.968892e-03 

\end{verbatim}
\normalsize

{\em Interaction With Spectral Profile Tool:} The {\tt Spectral Profile} display (see \S~\ref{section:display.image.specprof}), when active, 
updates on {\em each change} of the rectangle, polygon, or point position. 

%%%%%%

\subsection{Saving and Restoring Display Panel State}
\label{section:display.viewerGUI.save-restore}

You can save the display panel's current state --- meaning the 
panel settings and the data on display --- or load a saved panel
state from disk. To save the display panel state, select {\bf Save Panel State}
from the {\bf Display Panel} drop-down menu or click the 
"Save Display Panel State to File" icon on the main toolbar 
(an arrow pointing from a picture to a page, the seventh icon from left in Figure
\ref{fig:viewer_maintoolbar}). It is advisable but not required to retain the file's '.rstr' ("Restore")
extension.

You can restore the display panel to the saved state by loading the saved
state from the Data Manager Panel, by selecting {\bf Restore Panel State}
from the {\bf Display Panel} drop down menu, or by clicking the "Restore Display Panel State"
icon (just to the right of the "Save Display Panel State" icon).

It is possible to restore panel states viewing Measurement Sets or image and
panel states that have multiple layers, such as
contour plots over raster images. You can also save LEL displays. 
You can also the save or restore the panel state with no data loaded, which is a
convenient way to restore preferred initial settings such as overall panel size.

{\em Data Locations:} The viewer is fairly forgiving regarding data location when restore a saved panel state.
It will find files located:
\begin{itemize}
  \item in the original location recorded in the restore file
  \item in the current working directory (where you started the viewer)
  \item in the restore file's directory
  \item in the original location relative to the restore file
\end{itemize}
This means that you can generally restore a saved panel state if you move that
file together with data files. The exception to this rule is that the process is less forgiving
if you save the display of an LEL expression. In this case the files must be in the locations 
specified in the original LEL expression.  If a data file is {\bf not} found, restore
will attempt to proceed but results may not be ideal. 

{\em Manually Editing Saved Display Panel States:} The saved "Restore" files are in ascii 
(xml) format, and manual edits are possible. However, these files are long and complex.  Use caution, and back 
up restore files before editing. If you make a mistake, the viewer may not  even recognize the file as a restore file.  
It is easier and safer to make changes on the display panel and then save the display panel state again.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{The Data Manager Panel --- Saving and Loading Data}
\label{section:display.dataManager}

\begin{figure}[h!]
\begin{center}
\pngname{viewer_load}{4}
\caption{\label{fig:viewer_load} The {\bf load} tab of the {\bf Data Manager} panel.
This appears if you open the {\tt viewer} without any {\tt infile} 
specified, if you use select {\bf Open} from the {\bf Data} drop down menu, or click the
Open (Folder) icon. You can access the {\bf save image} or {\bf save region} tabs
from this view or by selecting {\bf Save as...} from the {\bf Data} drop down menu.
The load tab shows all files in the current directory that can be loaded into the viewer 
--- images, MS, CASA region files, and Display Panel State files.}
\end{center}
\hrulefill
\end{figure}

You can use the {\bf Data Manager Panel} to interactively save  and load
images, Measurement Sets, Display Panel States, and regions. An 
example of the loading tab in this panel is shown in Figure~\ref{fig:viewer_load}.  This
panel appears automatically if you open the viewer without specifying
an infile or it can be accessed through the {\tt Data:Open} menu or Open icon
of the {\bf Viewer Display Panel}.

\subsection{Loading Data}
\label{section:display.dataManager.load}

The {\bf load} tab of the {\bf Data Manager Panel} allows you to interactively
choose images or Measurement Sets to load into the viewer. The load tab
automatically shows you the available images, Measurement Sets, and
Display Panel States in the current directory that can be opened by the viewer.
When you highlight an image in this view, the tab shows a brief summary of
the image: pixel shape, extent of the image on the sky and in frequency/velocity, and 
restoring beam (if available).

Selecting a file also provide options for how to display the data. Images can be displayed as: 

\begin{enumerate}
\item raster image 
\item contour map 
\item vector map
\item marker map  
\end{enumerate}

These options area each discussed in \S\,\ref{section:display.image}.

{\em LEL:} Instead of only loading an image from disk, you may ask the
viewer to evaluate a 'Lattice Expression Language' (LEL) expression (\S~\ref{section:analysis.pars.lattice}). This can
be entered in the box provided after you click the "LEL" box. The images used in the
LEL expression should have the same coordinates and extents. 

{\em Measurement Sets:} A Measurement Set can only be displayed as a raster. For 
measurement sets, the load tab offers options for data selection. This will reduce 
loading and processing times for visibility flagging.  

{\em Regridding Images on Load:} Optionally, you may regrid the velocity axis of an image 
on load to match the current coordinates grid in the Display Panel. In this case, the viewer
will interpolate (using the selected interpolation scheme) the cube on disk to share the 
same velocity gridding as the loaded coordinates. This can be used, e.g., to overlay contour
maps of different spectral lines or to make synchronized moves of multiple cubes. Note that
the regridding depends on the rest frequency in the image. 

\subsection{Registered vs. Open Datasets}
\label{section:display.viewerGUI.load.register}

When you load data as described above, it is first {\em opened}, and then
{\em registered} on all existing {\tt Display Panels}.  

An {\em open} dataset has been prepared in memory from disk.  All open datasets will 
have a tab in the {\tt Data Display Options} window, whether currently registered or not.  

When a data set is {\em registered} to a Display Panel its coordinates are aligned to
the other displays in the panel and it is ready for drawing. If multiple Display Panels are open
then a data set may be registered on one {\tt Display Panel} and not on another. Only those
data sets registered on a particular Display Panel show up in its {\bf Position Tracking}
panel.

{\em Why Register More Than One Image?} It is useful to have more than one image registered on a
panel if you are displaying a contour image over a raster image
(\S~\ref{section:display.image.viewcontours}) or 'blinking' between images
(see {\bf Animator} in \S~\ref{section:display.viewerGUI.displaypanel}).

{\em Unregistering Images:} A data set can be registered or unregistered using the {\bf Register}
item in the {\bf Data} drop down menu or the {\bf Register} icon (third from left). Click the name of the image to
toggle its registration state in that Display Panel. Failing to unregister or close data sets that are 
no longer in use (or not compatible with other data in the Display Panel) may cause problems with 
the viewer. 

{\em Closing vs. Unregistering:} You can close a data set that is no longer needed using the {\bf Close}
option in the {\bf Data} drop-down menu or the "Close" icon (fourth from left). 

If you close a dataset, you must reload it from disk (or recreate it) to see it again.  If you
unregister a dataset, it will draw immediately if you re-register it, with its options as you have 
previously set them.  In general, close unneeded datasets but unregister those that you intend to use again.

\subsection{Saving Data or Regions}
\label{section:display.viewerGUI.save}

\begin{figure}[h!]
\begin{center}
\pngname{viewer_save}{4}
\caption{\label{fig:viewer_save} The {\bf Save Data - Image} panel
that appears when pressing the 'save region
(Figure~\ref{fig:viewer_maintoolbar}).} 
\hrulefill
\end{center}
\end{figure}

The viewer can create new images by carrying out velocity regridding, evaluating an LEL
expression, or collapsing a data cube. You can save these images to disk using the 
Data Manager Panel. Select {\bf Save as} under the {\bf Data} drop-down menu or
click the {\bf Save as} (disk) icon to bring up the Data Manager Panel set to the save tabs.
This tab is shown in Figure~\ref{fig:viewer_save}. 

From the Save Image tab of the Data Manager Panel, you can export images from the
viewer to either a CASA image or FITS file on disk. Select the desired file name and click
"save."

The Data Manager also allows you to save the loaded regions to a file, either in the CASA
region or ds9 format. The left part lists all images that can be exported to disk.  To save an
image to a file, the use can either enter the new filename in the box
labeled 'output name:' followed by the save-button (alternatively the
'Enter'-key), or choose a file name from the right hand side.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Viewing Images}
\label{section:display.image}

There are several options for viewing an image.  These are seen
at the right of the {\bf Load Data - Viewer} panel 
described in \S~\ref{section:display.dataManager.load} and shown in 
Figure~\ref{fig:viewer_start} after selecting an image.  They are:
\begin{itemize}
   \item {\tt raster image} --- a greyscale or color image,
   \item {\tt contour map} --- contours of intensity as a line plot,
   \item {\tt vector map} --- vectors (as in polarization) as a line plot,
   \item {\tt marker map} --- a line plot with symbols to mark positions.
\end{itemize}

The {\tt raster image} is the default image display, and is what you
get if you invoke the {\tt viewer} from {\tt casapy} with an image
file name.  In this case, you will need to use the {\tt Open} menu to
bring up the {\bf Load Data} panel to choose a different display.
%
%\begin{figure}[h!]
%\begin{center}
%\pngname{viewer_load_image}{4}
%\caption{\label{fig:viewer_load_image} The {\bf Load Data - Viewer} panel
%as it appears if you select an image.  You can see all options
%are available to load the image as a {\tt raster image}, 
%{\tt contour map}, {\tt vector map}, or {\tt marker map}.
%In this example, clicking on the {\tt raster image} button would 
%bring up the displays shown in Figure~\ref{fig:viewer_start}.}
%\hrulefill
%\end{center}
%\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Viewing a raster map}
\label{section:display.image.raster}

A raster map of an image shows pixel intensities in a two-dimensional
cross-section of gridded data with colors selected from a finite set
of (normally) smooth and continuous colors, i.e., a colormap.

% \begin{figure}[h!]
% \gname{viewer1}{3.5}
% \gname{viewer_loaddata}{3.5}
% \caption{\label{fig:viewer1} casaviewer: Illustration of a raster
%   image in the Viewer Display Panel(left) and the Load Data panel
%   (right).} 
% \hrulefill
% \end{figure}

Starting the {\tt casaviewer} with an image as a raster map will look
something like the example in Figure~\ref{fig:viewer_start}. 
 
You will see the GUI which consists of two main windows, entitled
"Viewer Display Panel" and "Load Data". In the "Load Data" panel, you
will see all of the viewable files in the current working directory along
with their type (Image, Measurement Set, etc).  After selecting a file, you
are presented with the available display types (raster, contour,
vector, marker) for these data. Clicking
on the button {\tt raster image} will create a display
Fig.~\ref{fig:viewer_start}. 

The data display can be adjusted by the user as needed.  This
is done through the {\bf Data Display Options} panel.  This window
appears when you choose the {\tt Data:Adjust} menu or use the
wrench icon from the {\bf Main Toolbar}.  This also comes up
by default along with the {\bf Viewer Display Panel} when the
data is loaded.

The {\bf Data Display Options} window is shown in the right panel
of Figure~\ref{fig:viewer_start}.  It consists of a tab for each
image or MS loaded, under which are a cascading series of expandable
categories.  For an image, these are:
\begin{itemize}
   \item {\bf display axes}
   \item {\bf hidden axes}
   \item {\bf basic settings}
   \item {\bf position tracking}
   \item {\bf axis labels}
   \item {\bf axis label properties}
   \item {\bf beam ellipse}
   \item {\bf color wedge}
\end{itemize}
The {\bf basic settings} category is expanded by
default.  To expand a category to show its options, click on it with
the left mouse button.


%%%%%%
\subsubsection{Raster image --- display axes}
In this category the physical axes (i.e. Right Ascension, Declination,
Velocity, Stokes) to be displayed can be selected and assigned to the
x, y, and z axes of the display. If your image has a fourth axis
(typically Stokes), it can be controlled by a slider within the {\tt
  hidden axes} drop-down.

\subsubsection{Raster image --- basic settings}
\label{section:display.image.raster.adjust.basic}

This roll-up is open by default.  It has some commonly-used parameters
that alter the way the image is displayed; three of these affect the
colors used. An example of this part of the panel is shown in
Figure~\ref{fig:viewer_raster_basic}.

\begin{figure}[h!]
\begin{center}
\pngname{viewer_ras_basic}{4}
\caption{\label{fig:viewer_raster_basic} The {\tt basic settings}
category of the {\bf Data Display Options} panel
as it appears if you load the image as a {\tt raster image}.
This is a zoom-in for the data displayed in Figure~\ref{fig:viewer_start}.}
\hrulefill
\end{center}
\end{figure}

The options available are:
\begin{itemize}

\item {\tt basic settings: aspect ratio}

This option controls the horizontal-vertical size ratio of data pixels
on screen.  {\tt fixed world} (the default) means that the aspect
ratio of the pixels is set according to the coordinate system of
the image (i.e., true to the projected sky). {\tt fixed lattice}
means that data pixels will always be square on the screen.  Selecting
{\tt flexible} allows the map to stretch independently in each
direction to fill as much of the display area as possible.

\item {\tt basic settings: pixel treatment}

This option controls the precise alignment of the edge of the current
'zoom window' with the data lattice.  {\tt edge} (the default) means
that whole data pixels are always drawn, even on the edges of the display.
For most purposes, {\tt edge} is recommended.  {\tt center} means that
data pixels on the edge of the display are drawn only from their centers
inwards. (Note that a data pixel's center is considered its 'definitive'
position, and corresponds to a whole number in 'data pixel' or 'lattice'
coordinates).

\item {\tt basic settings: resampling mode}

This setting controls how the data are resampled to the resolution of
the screen.  {\tt nearest} (the default) means that screen pixels are
colored according to the intensity of the nearest data point, so that
each data pixel is shown in a single color. {\tt bilinear} applies a
bilinear interpolation between data pixels to produce smoother looking images
when data pixels are large on the screen.  {\tt bicubic} applies an
even higher-order (and somewhat slower) interpolation.

\item {\tt basic settings: data range}

You can use the entry box provided to set the minimum and maximum data values
mapped to the available range of colors as a list {\tt [min, max]}.  
For very high dynamic range images,
you will probably want to enter a {\tt max} less than the data maximum 
in order to see detail in lower brightness-level pixels.
The next setting also helps very much with high dynamic range data.

\item {\tt basic settings: scaling power cycles}

This option allows logarithmic scaling of data values to colormap cells.  

The color for a data value is determined as follows: first, the value
is clipped to lie within the data range specified above, then mapped
to an index into the available colors, as described in the next
paragraph. The color corresponding to this index is determined finally
by the current colormap and its 'fiddling' (shift/slope) and
brightness/contrast settings (see {\bf Mouse Toolbar}, above).  Adding
a {\bf color wedge} to your image can help clarify the effect of the
various color controls.

The {\tt scaling power cycles} option controls the mapping of clipped data
values to colormap indices.  Set to zero (the default), a straight linear
relation is used.  For negative scaling values, a logarithmic mapping
assigns an larger fraction of the available colors to lower data values (this
is usually what you want). Setting {\tt dataMin} 
to something around the noise level
is often useful/appropriate in conjunction with a negative 'power cycles'
setting. 

For positive values, an larger fraction of the colormap is used for the high
data values\footnote{The actual functions are computed as follows:

For negative scaling values (say $-p$), the data is scaled linearly
from the range ({\tt dataMin} -- {\tt dataMax}) to the range (1 -- $10^{p}$).
Then the program takes the $\log$ (base 10) of that value (arriving at
a number from 0 to $p$) and scales that linearly to the number of
available colors.  Thus the data is treated as if it had $p$ decades
of range, with an equal number of colors assigned to each decade.

For positive scaling values, the inverse (exponential) functions are used.
If $p$ is the (positive) value chosen,  The data value is scaled linearly to
lie between 0 and $p$, and 10 is raised to this power, yielding a value in the
range (1 -- $10^{p}$).  Finally, that value is scaled linearly to the number
of available colors.}.

See Figure~\ref{fig:scalingpower} for sample curves.
\begin{figure}[h]
\begin{center}
\pngname{viewer_scalingpower}{3.6}
\caption{\label{fig:scalingpower} Example curves for {\tt scaling power cycles}.}
\hrulefill
\end{center}
\end{figure}

\item {\tt basic settings: colormap}

You can select from a variety of colormaps here.  {\tt Hot Metal},
{\tt Rainbow} and {\tt Greyscale} colormaps are the ones most commonly used.

\end{itemize}


%%%%%%
\subsubsection{Raster image --- other settings}
\label{section:display.image.raster.adjust.other}

Many of the other settings on the {\tt Data Options} panel for raster images
are self-explanatory, such as those which affect {\tt beam ellipse} drawing
(only available if your image provides beam data), or the form of the
{\tt axis labeling} and {\tt position tracking} information.  You can also
give your image a {\tt color wedge}, a key to the current mapping from data
values to colors.

You can control which of your image's axes are on the vertical and horizontal
display axes and which on the animation or 'movie' axis, within the
{\tt display axes} drop-down.  You must set the X, Y and Z (animation) axes
so that each shows a {\it different} image axis, in order for your choice
to take effect.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Viewing a contour map}
\label{section:display.image.contour}

Viewing a contour image is similar to the process above. A contour map
shows lines of equal data value (e.g., flux density) for the
selected plane of gridded data (Figure~\ref{fig:viewer_con}).
Contour maps are particularly useful for overlaying on raster images so
that two different measurements of the same part of the sky can be shown
simultaneously (\S~\ref{section:display.image.viewcontours}).

Several {\tt basic settings} options control the contour levels used.
The contours themselves are specified by a list in the box {\tt
  Relative Contour Levels}.  These are defined relative to the two
other parameters, the {\tt Base Contour Level} (which sets what 0 in the
relative contour list corresponds to in the image), and the {\tt
  Unit Contour Level} (which sets what 1 in the relative contour list
corresponds to in the image).  Note that negative contours are usually
dashed. 
%Default values (selectable by the wrench symbol) are the
%minimum and maximum value of the image. 
 {\bf ALERT:} This scheme was
adopted in 2.4.0 and is slightly different to that used in previous
versions.

% \begin{figure}[h!]
% \gname{viewer5}{3.5}
% \gname{viewer_displaydata5}{3.5}
% \caption{\label{fig:viewer5} Example of a contour
%   image in the {\bf Viewer Display Panel} (left) and the 
%   {\bf Load Data} panel (right).} 
% \hrulefill
% \end{figure}
 
\begin{figure}[h!]
\begin{center}
\pngname{viewer_n5921_con_1}{4.3}
\pngname{viewer_n5921_con_2}{2.1}
\caption{\label{fig:viewer_con} The {\bf Viewer Display Panel}
(left) and {\bf Data Display Options} panel (right) after choosing
{\tt contour map} from the {\bf Load Data} panel.  The
image shown is for channel 11 of the NGC5921 cube, selected using
the {\bf Animator} tape deck, and zoomed in using the tool bar icon.
Note the different options in the open {\tt basic settings} category
of the {\bf Data Display Options} panel (as compared to {\tt raster image} in
Figure~\ref{fig:viewer_start}).} 
\hrulefill
\end{center}
\end{figure}

For example, it is relatively straightforward to set fractional
contours (e.g. ``percent levels''), e.g.:
\small
\begin{verbatim}
   Relative Contour Levels = [0.2, 0.4, 0.6, 0.8]
   Base Contour Level = 0.0
   Unit Contour Level = <image max>
\end{verbatim}
\normalsize
This maps the maximum to 1 and thus our contours are fractions of
the peak.

Another example shows how to set absolute values so that the contours
are given in flux density units (Jy):
\small
\begin{verbatim}
   Relative Contour Levels = [0.010, 0.0.020, 0.040, 0.080, 0.160, 0.320]
   Base Contour Level = 0.0
   Unit Contour Level = 1.0
\end{verbatim}
\normalsize
Here we have contours starting at 10mJy and doubling every contour.

We can also set contours in multiples of the image rms (``sigma''):
\small
\begin{verbatim}
   Relative Contour Levels = [-3,3,5,10,15,20]
   Base Contour Level = 0.0
   Unit Contour Level = <image rms>
\end{verbatim}
\normalsize
Here we have first contours at negative and positive 3-sigma.
You can get the image rms using the {\tt imstat} task 
(\S~\ref{section:analysis.imstat}) or using the Viewer statistics
tool on a region of the image 
(\S~\ref{section:display.viewerGUI.displaypanel.region}).

As a final example, not all images are of intensity, for example a
moment-1 image (\S~\ref{section:analysis.moments}) has units of
velocity.  In this case,
absolute contours will work fine, but by default the viewer will
set fractional contours but referred to the min and max velocity:
\small
\begin{verbatim}
   Relative Contour Levels = [0.2, 0.4, 0.6, 0.8]
   Base Contour Level = <image min>
   Unit Contour Level = <image max>
\end{verbatim}
\normalsize
Here we have contours spaced evenly from min to max, and this is
what you get by default if you load a non-intensity image (like
the moment-1 image).  See Figure~\ref{fig:viewer_rascon} for an
example of this.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Overlay contours on a raster map}
\label{section:display.image.viewcontours}

Contours of either a second data set or the same data set can be used
for comparison or to enhance visualization of the data. The Data Options
Panel will have multiple tabs which allow adjusting each overlay
individually (Note tabs along the top).  {\bf Beware:} it's easy to forget
which tab is active!   Also note that {\tt axis labeling} is controlled
by the {\it first-registered} image overlay that has labeling turned on
(whether raster or contour), so make label adjustments within that tab.

To add a Contour overlay, open the {\bf Load Data} panel (Use the {\bf Data}
menu or click on the folder icon), select the data set and click on
{\tt contour map}.
See Figure~\ref{fig:viewer_rascon} for an example using NGC5921.

% \begin{figure}[h!]
% \gname{viewer_datadisplay1}{3.5}
% \gname{viewer3}{3.5}
% \caption{\label{fig:viewer_overlay}  Display of a contour
% overlay on top of a raster image.} 
% \hrulefill
% \end{figure}
 
%\begin{figure}[h!]
%\begin{center}
%\pngname{viewer_n5921_rascon_1}{3}
%\pngname{viewer_n5921_rascon_2}{3}
%\caption{\label{fig:viewer_rascon} The {\bf Viewer Display Panel}
%(left) and {\bf Data Display Options} panel (right) after overlaying
%a {\tt Contour Map} on a {\tt Raster Image} from the same image cube.  The
%image shown is for channel 11 of the NGC5921 cube, selected using
%the {\bf Animator} tape deck, and zoomed in using the tool bar icon.
%The tab for the contour plot is open in the {\bf Data Display Options} 
%panel.} 
%\hrulefill
%\end{center}
%\end{figure}

\begin{figure}[h!]
\begin{center}
\pngname{viewer_n5921_contour_moments_1}{4.3}
\pngname{viewer_n5921_contour_moments_2}{2.1}
\caption{\label{fig:viewer_rascon} The {\bf Viewer Display Panel}
(left) and {\bf Data Display Options} panel (right) after overlaying
a {\tt Contour Map} of velocity on a {\tt Raster Image} of intensity.  The
image shown is for the moments of the NGC5921 cube, zoomed in using the tool bar icon.
The tab for the contour plot is open in the {\bf Data Display Options} 
panel.} 
\hrulefill
\end{center}
\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{The Spectral Profile Tool}
\label{section:display.image.specprof}

\begin{figure}[h!]
\begin{center}
\pngname{viewer_specprof_1}{2.2}
\pngname{viewer_specprof_2}{3.3}
\caption{\label{fig:viewer_specprof} The {\bf Spectral Profile} panel (right)
that appears when pressing the button {\bf Open the Spectrum Profiler} in the
{\bf Main Toolbar} and then use the tools to select a region in the image,
such as the rectangular region on the left panel. The Spectral Profile tool
shows the most recent image highlighted and updates to track movements 
of the region if moved by dragging with the mouse.} 
\hrulefill
\end{center}
\end{figure}

The {\bf Spectral Profile Tool} allows you examine the intensity as a function
frequency or velocity. To start a new Spectral Profile window, click the 
{\bf Spectral Profile} option from the {\bf Tools} drop-down menu or click the 
"Spectral Profile" (red line graph) icon from the Main Toolbar 
(see Fig.~\ref{fig:viewer_maintoolbar}). A new Spectral Profile window will appear. 

{\em Make Sure That You Use the Radio Version:} This section describes the 
"Radio" version of the profiler. To be sure that you have the radio version of the tool
selected (this may not be the default), click on the preferences icon 
( the gear fourth from the left) and make sure that the "Optical" option is not checked.

The Spectral Profile Tool consists of a toolbar (\S \ref{section:display.image.specprof.toolbar}),
a main display area (\S \ref{section:display.image.specprof.mainwindow}), and three associated tabs:
{\bf Set Position} (\S \ref{section:display.image.specprof.setpos}), 
{\bf Spectral-Line Fitting} (\S \ref{section:display.image.specprof.specfit}), 
{\bf Line Overlays} (\S \ref{section:display.image.specprof.lineoverlay}).

{\em Interaction With the Main Display Panel:} For the Spectral Profile tool to work, a region or point
must be specified in the main Viewer Display window. Use the mouse tools to specify a point, 
rectangle, ellipse, or polygon region. Alternatively, load a region file. The Spectral Profile tool will show 
a spectrum extracted from the region most recently highlight by the mouse in the main Viewer Display Panel.
The method of extraction can be specified by the user; it is a mean by default).

The Spectral Profile tool can also feed back to the Main Display Panel. By holding CTRL and clicking
in the spectrum, you will cause the Main Display Panel to jump to display the frequency channel corresponding
to the spectral (x) coordinate of the region clicked in the Spectral Profile tool. Holding CTRL and dragging out
a spectral range will queue a movie scrolling through images across that spectral range.

\subsubsection{Spectral Profile Toolbar}
\label{section:display.image.specprof.toolbar}

\begin{figure}[h!]
\begin{center}
\pngname{viewer_spectoolbar}{4}
\caption{\label{fig:viewer_spectoolbar} The toolbar for the Spectral Profile tool allows the user to
save the spectrum, print or save the tool as an image, edit preferences (general, tool, legend), and
pan or zoom around the spectrum.}
\hrulefill
\end{center}
\end{figure}

Figure \ref{fig:viewer_spectoolbar} shows the toolbar from the top portion of the {\bf Spectral Profile} 
window. From left to right, the icons allow the user to:

\begin{itemize}
\item (disk) export the current profile to a FITS or ASCII file
\item (printer) print the main window to a hard copy
\item (writing desk) save the panel as an image (PNG, JPG, PDF, etc.)
\item (gear) set plot preferences
\item (color wheel) set color preferences for the plot
\item (signpost) set legend preferences
\item (arrows) pan the spectrum in the indicated direction
{\em Note: The arrow keys also allow one to pan using the keyboard.}
\item (magnitfying glass) zoom to the default zoom, in, and out
{\em Note: the +/- keys allow one to zoom with the keyboard}
\end{itemize}


\begin{figure}[h!]
\begin{center}
\hrulefill \\
\pngname{viewer_prefs_1}{1.0}
\pngname{viewer_prefs_2}{2.5}
\pngname{viewer_prefs_3}{2.5}
\caption{\label{fig:viewer_prefs} Preferences options in the Spectral Profile Tool. From the toolbar, one
can access dialogs to set overall viewer preferences, colors for plotting, and how the plot legend is displayed.}
\hrulefill
\end{center}
\end{figure}

Figure \ref{fig:viewer_prefs} shows the setting dialogs accessible from the toolbar. 

The {\bf Preferences} dialog opened by the gear icon allows the user to:

\begin{itemize}
\item Toggle automatic scaling the x- and y-ranges of the plot. 
\item Toggle the coordinate grid overlay in the background of the plot.
\item Toggle whether registered images other than the current one appear as overlays on the plot.
\item Toggle whether these profiles are plotted relative to the main profile {\em (in development)}.
\item Toggle the display of tooltips {\em (in development)}.
\item Toggle the plotting of a top axis.
\item Toggle between a histogram and simple line style for the plot.
\item Toggle between the radio and optical versions of the Spectral Profile tool {\em Note: We discuss only the radio version here; this mainly
impacts the Spectral Line Fitting and Collapse/Moments functionality.}.
\item Toggle the overplotting of a line showing the channel currently being displayed in the main Display Panel.
\end{itemize}

The {\bf Color Curve Preferences} dialog opened by the color wheel icon allows the user to:

\begin{itemize}
\item Select the color of the line marking the current channel shown in the main Display Panel.
\item Select the color used to overlay molecular lines from Splatalogue.
\item Select the color to plot the initial Gaussian estimate used in spectral line fitting.
\item Select the color used for the zoom rectangle.
\item Set a queue of colors used to plot the various data sets registered in the Display Panel.
\item Set a queue of colors to plot the set of Gaussian fits.
\item Set a queue of colors to plot the synthesized curve.
\end{itemize}

Two sets of preset colors, "Traditional" or "Alternative", are available and the user can define
their own custom color palette.

The legend options opened by the signpost icon allow the user to toggle the plotting of
a legend defining the curves shown in the main Spectral Profile window. Using a drop-down 
dialog, the legend can be placed in the top left corner of the plot, to the right of the plot, or below the plot. 
Toggling the color bar causes the color of the curve to be indicated either via a short bar or using
the color of the text itself. Double click the names of the files or curves to edit the text shown for that curve 
by hand.

\subsubsection{Main Spectral Profile Window}
\label{section:display.image.specprof.mainwindow}

\begin{figure}[h!]
\begin{center}
\pngname{viewer_specmain}{4}
\caption{\label{fig:viewer_specmain} The main panel for the {\bf Spectral Profile} tool. Buttons along
the bottom row allow the axes to be set. Arrow keys pan and dragging out an area with the mouse zooms.
Holding CTRL and clicking in the spectrum will jump the main Viewer Display panel to display that
frequency channel.}
\hrulefill
\end{center}
\end{figure}

The main window shows the spectrum extracted from active region of the image in the 
main Display Panel and any other registered images if overlays are enabled.  Menus
along the bottom of the image allow the user to select how the spectrum is displayed. From left to
right:

\begin{itemize}
\item The units for the bottom spectral axis.
\item The units for the top spectral axis. {\em Note: only enabled if only a single image is registered
and the top axis option is enabled. Dual axes are not well-defined for mixed data sets.}
\item The units for the left intensity or flux axis {\em Note: fraction of peak allows easy comparison of data
with disparate intensity scales.}.
\item The velocity reference frame used if a velocity axis is chosen for the top or bottom axis.
\item The method used to extract spectrum from the region.
\item Toggle the calculation and overplotting of error bars calculated from scatter in the data ({\tt rmse} refers
to root mean square error).
\end{itemize}

%\begin{figure}[h!]
%\begin{center}
%\hrulefill \\
%\pngname{viewer_specmouse_1}{2.1}
%\pngname{viewer_specmouse_2}{2.1}
%\pngname{viewer_specmouse_3}{2.1}
%\caption{\label{fig:viewer_specmouse}With {\tt dragging the left mouse button}
%over the main window the user can interactively zoom into the profile
%(yellow box in left panel). Pressing the {\tt shift-key} while {\tt dragging the left mouse button}
%marks a spectral range with a gray area (middle panel) and provides
%start and end values for the tabs {\tt collapse/moments} and {\tt linefit}. With the
%{\tt ctrl-key} pressed, a gray line marks the cursor position. Clicking the {\tt left mouse button}
%displays the corresponding spectral channel in the {\bf Viewer Display Panel}.}
%\hrulefill
%\end{center}
%\end{figure}

In addition to these drop-down menus, the main Spectral Profile window allows the user to do the following using keyboard and mouse inputs: % (Figure \ref{fig:viewer_specmouse}):

\begin{itemize}
\item {\em jump the main Display Panel window to a specified channel (CTRL+click):} hold CTRL and click in the spectrum. A marker will appear and the
main Viewer Display Panel will jump to display that channel.
\item {\em animate the main Display Panel in a movie across a frequency range (CTRL+click+drag):} hold CTRL, click, and drag. The main Viewer Display
panel will respond by showing a movie scrolling across the selected spectral channels.
\item {\em zoom the Spectral Profile (+/-, mouse drag)}: Use the +/- keys to zoom in the same
way as the toolbar buttons. Alternatively, press and dragging the left mouse button. A yellow box is drawn onto the panel. After releasing the mouse button,
the plot will zoom to the selected range.
\item {\em pan the Spectral Profile (arrows)}: Use the arrow keys to pan the plot.
\item {\em select a spectral range"} hold shift, click and drag. A gray area will be swept out in the display. This method can be used to select a range
for spectral line fitting or collapsing a data cube.
\end{itemize}

\subsubsection{Set Position}
\label{section:display.image.specprof.setpos}

\begin{figure}[h!]
\begin{center}
\pngname{viewer_setpos}{4}
\caption{\label{fig:viewer_setpos} The Set Position tab in the Spectral Profile Tool. Here user can specify the center and extent (for rectangles) of 
the region under consideration by hand.}
\hrulefill
\end{center}
\end{figure}

The Spectral Profile Tool displays the spectrum extracted from the
highlighted region in the main Viewer Display Panel. The {\bf Set
  Position} tab inside the Spectral Profile Tool allows the user to
refine the position of this region manually. Shown in Figure
\ref{fig:viewer_setpos}, this tab allows the user to type in a new
R.A. and Declination or pixel center for a point or rectangle
region. The user may also specify the extent of the rectangular region
by setting the {\bf Type} drag-down menu to Rectangle. Currently this
feature only works for points or rectangular regions ({\em in
  development}).

\subsubsection{Spectral-Line Fitting}
\label{section:display.image.specprof.specfit}

\begin{figure}[h!]
\begin{center}
\pngname{viewer_specfit_1}{4}
\caption{\label{fig:viewer_specproffit} The Spectral Line Fitting tab in the 
Spectral Profile Tool. The user can fit a combination of a polynomial and multiple Gaussian components,
specifying the range to be fit (gray region) manually or with a shift+click+drag. Initial estimates for each component
may be entered by hand or specified via an initial estimates GUI. The results are output to a dialog and text file with
the fit overplotted (here in blue) on the spectrum (with the possibility to save it to disk).}
\end{center}
\end{figure}

\begin{figure}[h!]
\begin{center}
\pngname{viewer_specfit_2}{3}
\pngname{viewer_specfit_3}{3}
\caption{\label{fig:viewer_specproffit_2} The left panel shows the graphical specification of initial estimates for Gaussian fitting.
Slider bars specify the center, FWHM, and peak intensity for the initial estimate. The right panel shows the verbose output of
the fitting.}
\hrulefill
\end{center}
\end{figure}

{\em Very much under active development.}

The {\bf Spectral-Line Fitting} tab, shown in Figures \ref{fig:viewer_specproffit} and \ref{fig:viewer_specproffit_2}, 
allows the user to interactively fit a combination of Gaussian and polynomial profiles to the data shown 
in the Spectral Line Profile tool. The tool includes a number of options, many of which remain under
development:

\begin{itemize}
\item A drag-down menu at the top of the panel allows the user to pick which data set to fit.
\item The spectral range to fit can be specified by either holding shift+click+dragging or by typing it manually
into the box at the top left.
\item Optionally multiple fits can be carried out once. ({\em Under development.})
\item Optionally a polynomial of the specified order may be fit. 
\item The results may be saved to a text file. This text file should be specified {\em before} the fit is carried out. {\em Note that 
the fit curve itself becomes a normal spectral profile data set and can be saved to disk using the toolbar (disk icon) after the 
fit.}
\item One or more Gaussians can be fit ({\em Results are presently most stable for one Gaussian.}). Specify the number of
Gaussians and then enter initial estimates for the peak, center, and FWHM in the table below. Any of these values can be fixed
for any of the Gaussians being fit. Initial estimates can also be manually specified by clicking {\bf Specify Estimates.} This brings up an additional 
GUI window (Figure \ref{fig:viewer_specproffit_2}), where slides can be used to specify initial estimates for each Gaussian to be fit.
\end{itemize}

Currently the tool works well for specifying a single Gaussian. Fitting multiple components can become unstable (often due to poor 
choice of initial estimates). This is an area of active development and future releases will offer improved capabilties.

\subsubsection{Line Overlays}
\label{section:display.image.specprof.lineoverlay}

\begin{figure}[h!]
\begin{center}
\pngname{viewer_lineoverlay}{4}
\caption{\label{fig:viewer_lineoverlay} Line Overlays in the Spectral Profile Tool. The {\bf Line Overlay} tab, shown at the bottom,
allows users to query the CASA copy of the Spaltalogue spectral line database. Enter the redshift of your source (right panel),
select and Astronomical Filter from the drop down menu, and use shift+click+drag to select a frequency range (or do so manually). 
The "Search" button will bring up the dialog seen at the left top part of the image, which can in turn be used to graph the candidate
lines in the main Spectral Profile window (here CO v=0).}
\hrulefill
\end{center}
\end{figure}

{\em Very much under active development.}

This experimental new feature, shown in Figure \ref{fig:viewer_lineoverlay}, allows the user to search the portion of the Splatalogue database
that is packaged with CASA to identify spectral lines in the region of interest. Select the {\bf Line Overlays}
tab. If know, enter the redshift or velocity of your source in the "Doppler Shift" panel. Specify a minimum and maximum frequency range to
search or, even easier, hold shift and drag out a range in the spectrum (you will see a gray box appear). Optionally, you may select 
an astronomical filter from the list --- this is usually a good idea, to pare the potentially very large list of candidate lines to a smaller set of
reasonable candidates. 

Click "Search" and the Spectral Profile will search Splatalogue for a list of Spectral lines that that fit that Astronomical
Filter in that frequency range for that redshift. A dialog will pop up showing the list of candidate lines. Highlight one or more of them and
click "Graph Selected Lines." A set of vertical markers will appear in the main Spectral Profile window at the appropriate (redshifted)
frequencies for the line.

We emphasize that this feature remains under active development. Look for improved performance and an expanded feature set in the next release.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{The Collapse/Moments Tool}
\label{section:display.image.collapse}

\begin{figure}[h!]
\begin{center}
\pngname{viewer_collapse}{4}
\caption{\label{fig:viewer_collapse} The {\bf Collapse/Moments} tool, accessed from
the Main Toolbar or the {\bf Tools} drop down menu. The mean spectrum from the region 
in the Main Display Panel appears in the top part of the tool. After selecting a range,
a moment to calculate, and optionally data to exclude click collapse to calculate a new image.}
\hrulefill
\end{center}
\end{figure}

{\em This area is under active development.}

{\em Major Caveat: The collapse tool currently works only on CASA images, not FITS files.}

The collapse/moments tool, available from the main toolbar (arrows), allows the user
to interactively collapse an image cube into a plane using a wide variety of algorithms. Load a data cube and
click the collapse icon or select {\bf Collapse/Moments} from the drop down {\bf Tools} menu.

The tool uses the same format as the Spectral Profile tool and will show the integrated spectrum of whatever region
or point is currently selected in the main Display Panel. The window that comes up allows the user to select the spectral range 
manually or via a shift+click+drag motion of the mouse (sweeping out a gray area). A list of available calculations appears in the center 
of the panel. One can select anywhere from one to all of these. In the right side of the panel, one can select a range of values to 
include or exclude from the calculation (e.g., to engage in an approximation of $\sigma$-clipping or something similar). 

The results can be saved to a file. If they are not, then they will be saved to a temporary file and can later be saved from the Data Manager
panel using the {\bf Save Image} functionality.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Managing Regions and Annotations}
\label{section:display.image.rgnmgr}

CASA regions are following the CASA 'crtf' standard as described in
\S~\ref{chapter:regionformat}. CASA regions can be used in all
applications, including {\tt clean} and image analysis tasks
(\S\,\ref{chapter:analysis}). In addition, a leading 'ann' to each
region definition indicates that it is for visual overlay purposes
only. On a side note: apart from the regions mentioned here, CASA supports
image masks, i.e. images that contain only 0 and 1 (or 0 a non-0). In
some images, masks are stored in a True/False Boolean format. 

{\bf Alert:} Whereas the region format is supported by all the data
  processing tasks, the {\tt viewer} implementation is still limited
  to rectangles, ellipses, and some markers. We expect the full
  implementation to be available in a future CASA release. 


  Regions can be created with the buttons marked as 'R' in the mouse
  tool bar (\S~\ref{section:display.viewerGUI.displaypanel},
  \S~\ref{section:display.viewerGUI.displaypanel.region}). The viewer
  currently supports rectangles, ellipses, polygons, and the point. As
  usual, a mouse button can be assigned to each button as indicated by
  the small black square in each button (marking the left, middle, or
  right mouse button \S~\ref{section:display.viewerGUI.displaypanel},
  \S~\ref{section:display.viewerGUI.displaypanel.region}). An example
  is shown in Fig.\,\ref{fig:viewer_regions}.


\begin{figure}[h!]
\begin{center}
\pngname{viewer-regions}{7}
\caption{\label{fig:viewer_regions} Selecting an image region with the
region tools. The region panel is shown to the right.}
\hrulefill
\end{center}
\end{figure}

{\bf Regions can be selected by SHIFT+click, de-selected by pressing
  SHIFT+click again, and removed by hitting the ESC button. }


Once regions are selected, they will feature little, skeletal squares
in the corners of their boundary boxes. This distinguishes them from a
zoom box (magnifier
glass \S~\ref{section:display.viewerGUI.displaypanel}), where the
corners are solid. 

Regions can be moved by dragging with the mouse button and if more
than one region is selected, all selected regions move together.

To load a region one can use the regular {\tt Load Data Browser}.To
load, unload, modify, and to display the value statistics of each
region, the Region Panel can be loaded via the
'View'$\rightarrow$'region' drop-down menu. As all other panels, the
region panel can be docked to different portions of the viewer and it
can also be detached. If it is dismissed (the cross in the upper right
corner), it can be retrieved by the {\tt 'View'} menu.

The three basic windows of the region panel are shown in
Fig.\,\ref{fig:viewer_regionpanel}.

\begin{figure}[h!]
\begin{center}
\pngname{region-panel-all}{4}
\caption{\label{fig:viewer_regionpanel} The three vertical tabs of the
region panel: {\tt properties}, {\tt stats}, and {\tt file}.}
\hrulefill
\end{center}
\end{figure}

\subsubsection{Region Panel: properties}
\label{section:display.image.rgnmgr.props}

The bottom of this panel features a slider to switch between regions
in the image. Regions can be removed by hovering over and pressing
{\tt ESC} or by pressing the buttons to the right side of the slider
where the first button deletes all regions and the far right button
deletes the region that is currently displayed in the panel.

The properties tab can be used to adjust the the size, center, and
coordinate frame of the region ({\tt 'coordinates'} selection at the
top). The inputs can be in different units, and those implemented in
the viewer are commonly used sub-sets of the options listed
in \S\,\ref{chapter:regionformat}. At the top of the panel, one can
specify the channel range over which the region shall be defined. The {\tt
  'selection'} check box is an alternative way to the {\tt
  SHIFT+click} to select a region. The {\tt 'annotation'} checkbox
will place the {\tt 'ann'} string in front of the region ascii output
-- annotation regions are not be used for processing in, e.g. data
analysis tasks.


The second horizontal tab {\tt 'line'} brings up a panel to change the
color, line width, and line style (solid, dotted, dashed) of the
selected region. 

The third panel, {\tt 'text'}, can be used to assign a string to the
region which can be controlled in position (the little dial at the
bottom, and the two right hand boxes), as well as text font, style,
and color. 


\subsubsection{Region Panel: stats}
\label{section:display.image.rgnmgr.stats}

The second vertical tab, 'stats', displays the statistics of each
region. When more than a single region is drawn, one can select them
one by one and the region panel updates image information and value
statistics for each region. The informational section contains the
frequency, velocity, stokes and brightness unit of the image. The beam
area is also calculated from the header information of the image. The
statistical properties of the pixels within in the region comprises
the number of pixels (Npts), the Sum, Mean, RMS, Minimum, and Maximum
of the pixel values, as well as the image flux integrated over the
region. All values are updated on the fly when the region is dragged
across the image.

Note that double-clicking the region will output the 
statistics to the terminal as explained above. This is an easy way to
copy and paste the statistical data to a program outside of CASA for
further use. 


\subsubsection{Region Panel: file}
\label{section:display.image.rgnmgr.file}

The third tab 'file' is used for loading and saving regions from and
to disk (select the appropriate the action at the top). {\it If no
  region has been created, the region panel will be empty. Use the
  regular ``Load Data'' file browser
  (\S~\ref{section:display.dataManager.load}) to load the a region file.}
To save to ascii file, one can specify the file format, where the
default is a CASA region file (saved with a *.crtf suffix, see
\S\,\ref{chapter:regionformat}). It is also possible to load and save
DS9 regions, but remember that the DS9 format does not offer the full
flexibility and cannot capture stokes and spectral axes. DS9 regions
will only be usable as annotations in the viewer, they cannot be used
for data processing in other CASA tasks.

When saving regions, one can also specify whether to save only the
current region, all regions that were selected with
SHIFT+click, or all regions that are visible on the screen. 


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Adjusting Canvas Parameters/Multi-panel displays}
\label{section:display.viewerGUI.canvas}

The display area can also be manipulated with the following controls in
the {\bf Panel Options} (or 'Viewer Canvas Manager') window.
Use the wrench icon with a 'P' (or the 'Display Panel' menu) to show this
window.
\begin{itemize}
   \item Margins - specify the spacing for the left, right, top, and bottom margins
   \item Number of panels - specify the number of panels in x and y
         and the spacing between those panels.
   \item Background Color - white or black (more choices to come)
\end{itemize}

%%%%%%
\subsubsection{Setting up multi-panel displays}
\label{section:display.viewerGUI.canvas.multi}

Figure~\ref{fig:viewer_canvas} illustrates a multi-panel display along
with the Viewer Canvas Manager settings which created it. 

\begin{figure}[h!]
\begin{center}
%\gname{viewer_canvas}{3}
%\gname{viewer4}{3}
\pngname{viewer_multipanel_canvas}{2.5}
\pngname{viewer_multipanel_view}{3.5}
\caption{\label{fig:viewer_canvas} A multi-panel display
set up through the {\bf Viewer Canvas Manager}.} 
\hrulefill
\end{center}
\end{figure}

%%%%%%
\subsubsection{Background Color}
\label{section:display.viewerGUI.canvas.background}

The {\bf Background Color} selection can be used to change the
background color from its default of {\tt black}.  Currently,
the only other choice is {\tt white}, which is more appropriate
for printing or inclusion in documents.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Viewing Measurement Sets}
\label{section:display.ms}

\begin{figure}[h!]
\begin{center}
\pngname{viewer_load_ms}{6}
\caption{\label{fig:viewer_load_ms} The {\bf Load Data - Viewer} panel
as it appears if you select an MS.  The only option available is
to load this as a {\tt Raster Image}.  In this example, clicking
on the {\tt Raster Image} button would bring up the displays shown
in Figure~\ref{fig:viewer_start_ms}.}
\hrulefill
\end{center}
\end{figure}

Visibility data can also be displayed and flagged directly from the
viewer. For Measurement Set files the only option for display is 'Raster'
(similar to AIPS task {\tt TVFLG}).  An example of MS display is
shown in Figure~\ref{fig:viewer_start_ms}; loading of an
MS is shown in Figure~\ref{fig:viewer_load_ms}.  

{\bf Warning:} {\em Only one MS should be registered at a time on a
Display Panel.} 
Only one MS can be shown in any case.  
You do not have to close other images/MSs, but you should at
least 'unregister' them from the Display Panel used for viewing the MS.
If you wish to see other images or MSs at the same time, create multiple
Display Panel windows.

% \begin{figure}[h]
% \gname{viewer_ms1}{3}
% \gname{viewer_ms2}{3}
% \caption{\label{fig:viewer_ms1} Display of visibility
%   data. The default axes are time vs. baseline.} 
% \hrulefill
% \end{figure}
 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Data Display Options Panel for Measurement Sets}
\label{section:display.ms.adjust}

The {\bf Data Display Options} panel provides adjustments for MSs
similar to those for images, and also includes flagging options.
As with images, this window appears when you choose the {\tt Data:Adjust}
menu or use the wrench icon from the {\bf Main Toolbar}. It is also shown
by default when an MS is loaded. The right panel
of Figure~\ref{fig:viewer_start_ms} shows a {\tt Data Options} window. 
It has a tab for each open MS, containing a set of categories.  The
options within each category can be either 'rolled up' or expanded by
clicking the category label.

For a Measurement Set, the categories are:
\begin{itemize}
   \item {\bf Advanced}
   \item {\bf MS and Visibility Selection}
   \item {\bf Display Axes}
   \item {\bf Flagging Options}
   \item {\bf Basic Settings}
   \item {\bf Axis Drawing and Labels}
   \item {\bf Color Wedge}
\end{itemize}

% (The envelope, please....  And the winner is...)

%%%%%%
\subsubsection{MS Options --- Basic Settings}
\label{section:display.ms.adjust.basic}

The {\bf Basic Settings} roll-up is expanded by
default.  It contains entries similar to
those for a raster image (\S~\ref{section:display.image.raster.adjust.basic}). 
Together with the brightness/contrast and colormap adjustment icons
on the {\tt Mouse Toolbar} of the Display Panel, they are especially
important for adjusting the color display of your MS.

The available Basic options are:

\begin{itemize}

\item {\tt Data minimum/maximum}

This has the same usage as for raster images.  
Lowering the data maximum will help brighten
weaker data values.

\item {\tt Scaling power cycles}

This has exactly the same usage as for raster images (see
\S~\ref{section:display.image.raster.adjust.basic}).  Again, lowering
this value often helps make weaker data visible.  If you want to view
several fields with very different amplitudes simultaneously, this is
typically one of the best adjustments to make early, together with the
{\tt Colormap fiddling} mouse tool, which is on the middle mouse button
by default.

\item {\tt Colormap}

{\tt Greyscale} or {\tt Hot Metal} colormaps are generally good choices
for MS data.

\end{itemize}



%%%%%%
\subsubsection{MS Options--- MS and Visibility Selections}
\label{section:display.ms.adjust.select}

\begin{itemize}

\item {\tt Visibility Type}

\item {\tt Visibility Component}

\item {\tt Moving Average Size}

\end{itemize}

This roll-up provides choice boxes for Visibility Type
(Observed, Corrected, Model, Residual) and Component (Amplitude,
Phase, Real, or Imaginary).  

\begin{figure}[h!]
\begin{center}
\pngname{viewer_n4826_axes1}{6}
\caption{\label{fig:viewer_axes_1} The MS for NGC4826 BIMA
observations has been loaded into the viewer.  We see the
first of the {\tt spw} in the Display Panel, and have opened
up {\tt MS and Visibility Selections} in the
{\bf Data Display Options} panel.  The display panel raster is
not full of visibilities because {\tt spw 0} is continuum and
was only observed for the first few scans.  This is a case where
the different spectral windows have different numbers of channels
also.}
\hrulefill
\end{center}
\end{figure}

Changes to Visibility Type or Component (changing from Phase to
Amplitude, for example) require the data to be retrieved again
from the disk into memory, which can be a lengthy process.  When a
large MS is first selected for viewing, the user must
trigger this retrieval manually by pressing the {\bf Apply} button
(located below all the options), after selecting the data to be
viewed (see {\tt Field IDs} and {\tt Spectral Windows}, below).

{\bf Tip:} Changing visibility type between 'Observed' and 'Corrected' can
also be used to assure that data and flags are reloaded from disk.  You
should do this if you're using another flagging tool such as autoflag
simultaneously, so that the viewer sees the other tool's new edits
and doesn't overwrite them with obsolete flags.  The {\bf Apply} button 
alone won't reload unless something within the viewer itself requires
it; in the future, a button will be provided to reload flags from the disk
unconditionally.  

You can also choose to view the difference from a running mean or the
local RMS deviation of either Phase or Amplitude.  There is a slider
for choosing the nominal number of time slots in the 'local neighborhood'
for these displays.

(Note: {\bf Insufficient Data} is shown in the tracking area during
these displays when there is no other unflagged data in the
local neighborhood to compare to the point in question.  The
moving time windows will not extend across changes in either field ID
or scan number boundaries, so you may see this message if your scan
numbers change with every time stamp.  An option will be added later
to ignore scan boundaries).

\begin{itemize}

\item {\tt Field IDs}

\item {\tt Spectral Windows}

\end{itemize}

You can retrieve and edit a selected portion of the MS data
by entering the desired Spectral Window and Field ID numbers into
these boxes.  {\bf Important:} Especially with large MSs, often the
first thing you'll want to do is to select {\bf spectral windows}
which all have the {\bf same number of channels} and the
{\bf same polarization setup}.  It also makes sense to edit only
a few fields at a time.   Doing this will also
greatly reduce data retrieval times and memory requirements.

You can separate the ID numbers with spaces or commas; you do not need to
enter enclosing brackets.  Changes to either entry box will cause
the selected MS data to be reloaded from disk.

If you select, say, spectral windows 7, 8, 23, and 24, the animator, slice
position sliders, and axis labeling will show 
these as 0, 1, 2, and 3 (the 'slice positions' or 'pixel coordinates' of the
chosen spectral windows).  Looking at the position tracking display is the best
way to avoid confusion in such cases.  It will show something like: 
{\tt Sp Win 23 (s 2)} when you are viewing spectral window 23 (plane 2
of the selected spectral windows).

Changes to MS selections will not be allowed until you have saved
(or discarded) any previous edits you have made (see {\tt Flagging Options 
-- Save Edits}, below).  A warning is printed on the console (not the logger).

Initially, all fields and spectral windows are selected.  To revert to
this 'unselected' state, choose 'Original' under the wrench
icons next to the entry boxes.

See Figure~\ref{fig:viewer_axes_1} for an example showing the use
of the {\tt MS and Visibility Selections} controls when 
viewing an MS.

%%%%%%
\subsubsection{MS Options --- Display Axes}
\label{section:display.ms.adjust.axes}

This roll-up is very similar to that for images: it allows the user to
choose which axes (from Time, Baseline, Polarization, Channel, and
Spectral Window) are are on the display and the animator.  There are
also sliders here for choosing positions on the remaining axes.  (It's 
useful to note that the data {\it is} actually stored internally in
memory as an array with these five axes).

\begin{figure}[h!]
\begin{center}
\pngname{viewer_n4826_axes2}{6}
\caption{\label{fig:viewer_axes_2} 
The MS for NGC4826 from Figure~\ref{fig:viewer_axes_1}, now with the
{\tt Display Axes} open in the {\bf Data Display Options} panel.  By
default, {\tt channels} are on the {\bf Animation Axis} and thus in
the tapedeck, while {\tt spectral window} and {\tt polarization} are
on the {\tt Display Axes} sliders. } \hrulefill
\end{center}
\end{figure}

For MSs, changing the choice of axis on one control will automatically
swap axes, maintaining different axes on each control.  Changing axes
or slider/animator positions does not normally require pressing
{\bf Apply} --- the new slice is shown immediately.  
However, the display may be 
partially or completely grey in areas if the required data is not
currently in memory, either because no data has been loaded yet, or
because not all the selected data will fit into the allowed memory.
Press the {\bf Apply} button in this case to load the data
(see \S~\ref{section:display.ms.adjust.apply} and 
{\tt Max. Visibility Memory} at the end of 
\S~\ref{section:display.ms.adjust.adv}).

\begin{figure}[h!]
\begin{center}
\pngname{viewer_n4826_axes3}{6}
\caption{\label{fig:viewer_axes_3} The MS for NGC4826,
continuing from Figure~\ref{fig:viewer_axes_2}.  
We have now put {\tt spectral window} on the {\bf Animation Axis} 
and used the tapedeck to step to {\tt spw 2}, where we see the
data from the rest of the scans.  Now {\tt channels} is on a
{\tt Display Axes} slider, which has been dragged to show
{\tt Channel 33}.}
\hrulefill
\end{center}
\end{figure}

Within the {\tt Display Axes} rollup you may also select whether to order
the baseline axis by antenna1-antenna2 (the default) or by (unprojected)
baseline length.

See Figures~\ref{fig:viewer_axes_2}--\ref{fig:viewer_axes_3}
showing the use of the {\tt Display Axes} controls to change the axes on the
animation and sliders.

%%%%%%
\subsubsection{MS Options --- Flagging Options}
\label{section:display.ms.adjust.flagging}

These options allow you to edit (flag or unflag) MS data.
The Point Tool and Rectangle Region {\bf Mouse Tools}
(\S~\ref{section:display.viewerGUI.displaypanel.region}) are used on
the display to select the area to edit.  When using the Rectangle Region
tool, double-click inside the selected rectangle to confirm the edit.

The options below determine how edits will be applied.

\begin{itemize}

\item {\tt Show Flagged Regions...}

You have the option to display flagged regions in the background
color (as in {\tt TVFLG}) or to highlight them with color.
In the former case, flagged regions look just like regions of no
data.  With the (default) color option, flags are shown in shades of blue:
darker blue for flags already saved to disk, lighter blue for
new flags not yet saved; regions with no data will be shown in black.

\item {\tt Flag or Unflag}

This setting determines whether selected regions will be flagged or
unflagged.  This does {\it not} affect previous
edits; it only determines the effect which later edits
will have.  Both flagging and unflagging edits can be accumulated
and then saved in one pass through the MS.

\item {\tt Flag/Unflag All...}

These flagging extent checkboxes allow you to extend your edit over any
of the five data axes.  For example, to flag {\it all} the data in a given
time range, you would check all the axes {\it except} Time, and then
select the desired time range with the {\tt Rectangle Region} mouse tool.
Such edits will extend along the corresponding axes over the entire selected
MS (whether loaded into memory or not) and optionally over unselected 
portions of the MS as well ({\tt Use Entire MS}, below).  Use care in
selecting edit extents to assure that you're editing all
the data you wish to edit.

\item {\tt Flag/Unflag Entire Antenna?}

This control can be used to extend subsequent edits to all baselines
which include the desired antenna[s].  For example, if you set this item
to 'Yes' and then click the point tool on a visibility position with
baseline 3-19, the edit would extend over baselines 0-3, 1-3, 2-3, 3-3,
3-4, ... 3-{\tt nAntennas-1}.  Note that the second antenna of the selection
(19) is irrelevant here -- you can click anywhere within the 'Antenna 3 block',
i.e., where the {\em first} antenna number is 3, to select all baselines
which include antenna 3.

This item controls the edit extent only along the baseline axis.  If you
wish to flag {\it all} the data for a given antenna, you must still check
the boxes to flag all Times, Channels, Polarizations and Spectral Windows.
There would be no point, however, in activating {\it both} this item and
the 'Flag All Baselines' checkbox.  You can flag an antenna in a limited
range of times, etc., by using the appropriate checkboxes and selecting
a rectangular region of visibilities with the mouse. 

{\bf Note:} You do not need to include the entire 'antenna block' in your
rectangle (and you may stray into the next antenna if you try). Anywhere
within the block will work.  To flag higher-numbered antennas, it often
helps to zoom in.

\item {\tt Undo Last Edit}

\item {\tt Undo All Edits}

The 'Undo' buttons do the expected thing: completely undo the effect of
the last edit (or all unsaved edits).  Please note,
however, that only unsaved edits can be undone here;
there is no ability to revert to the flagging state at the start of the
session once flags have been saved to disk (unless you have previously
saved a 'flag version'.  The flag version tool is not available through
the viewer directly).

\item {\tt Use Entire MS When Saving Edits?}

"Yes" means that saving the edits will flag/unflag over the entire MS,
{\it including} fields (and possibly spectral windows) which are not 
currently selected for viewing.  Specifically, data within time range(s)
you swept out with the mouse (even for unselected fields) will be edited.

In addition, if "Flag/Unflag All..." boxes were checked, such edits will
extend throughout the MS.  Note that only
unselected {\it times} (fields) can be edited {\it without} checking
extent boxes for the edits as well.  Unselected spectral windows, e.g.,
will {\it not} be edited unless the edit also has "Flag/Unflag All
Spectral Windows" checked.  

Warning: Beware of checking "All Spectral Windows" unless you have also 
checked "All Channels" or turned "Entire MS" off; channel edits appropriate 
to the selected spectral windows may not be appropriate to unselected
ones.  Set "Use Entire MS" to"No" if your edits need to apply only to the
portion of the MS you have selected for viewing.  {\it Edits can often be
saved significantly faster this way as well}.

Also note that checkboxes apply to individual edits, and must be checked
before making the edit with the mouse.  "Use Entire MS", on the other hand,
applies to all the edits saved at one time, and must be set as desired
before pressing "Save Edits".

\item {\tt Save Edits}

MS editing works like a text editor in that
you see all of your edits immediately, but nothing is committed to disk
until you press 'Save Edits'.  Feel free to experiment with all the other
controls; nothing but 'Save Edits' will alter your MS on disk. 
As mentioned previously, however, there is no way to undo your edits once
they are saved, except by manually entering the reverse edits (or restoring
a previously-saved 'flag version').

Also, {\it you must save} (or discard) {\it your edits before changing the 
MS selections}.  If edits are pending, the selection change will not be 
allowed, and a warning will appear on the console.  

If you close the MS in the viewer, {\it unsaved edits are simply discarded},
without prior warning.  It's important, therefore, to remember to save them
yourself.  You can distinguish unsaved flags (when using the 'Flags In Color'
option), because they are in a lighter shade of blue.

The program must make a pass through the MS on disk to save the edits.
This can take a little time; progress is shown in the console window.

\end{itemize}

%%%%%%
\subsubsection{MS Options---  Advanced}
\label{section:display.ms.adjust.adv}

These settings can help optimize your memory usage, especially for
large MSs.  A rule of thumb is that they can be increased until response
becomes sluggish, when they should be backed down again.

You can run the unix 'top' program and hit 'M' in it (to sort by memory
usage) in order to examine the effects of these settings.  Look at the
amount of RSS (main memory) and SWAP used by the X server and 'casaviewer'
processes.  If that sounds familiar and easy, then fiddling with these
settings is for you.  Otherwise, the default settings should provide
reasonable performance in most cases.

\begin{itemize}

\item {\tt Cache size}

The value of this option specifies the maximum
number of different views of the data to save so that they
can be redrawn quickly.  If you run an animation or scroll around
zoomed data, you will notice that the data displays noticeably faster
the second time through because of this feature.  Often, setting this
value to the number of animation frames is ideal  Note, however, that
on multi-panel displays, each panel counts as one cached image.

Large images naturally take more room than small ones.  The memory used
for these images will show up in the X server process.  If you need more
Visibility Memory (below) for a really large ms, it is usually better to
forgo caching a large number of views.

\item {\tt Max. Visibility Memory}

This option specifies how many megabytes of memory may be used to store
visibility data from the measurement set internally.  {\it Even if you do
not adjust this entry, it is useful to look at it to see how many megabytes
are required to store your entire (selected) MS in memory}.  If the slider
setting is above this, the whole selected MS will fit into the memory
buffer.  Otherwise, some data planes will be 'grayed out' (see 
{\tt Apply Button}, \S~\ref{section:display.ms.adjust.apply} below),
and the selected
data will have to be viewed one buffer at a time, which is somewhat less 
convenient. In most cases, this means you should {\bf select fewer fields
or spectral windows} -- see \S~\ref{section:display.ms.adjust.select}.
The 'casaviewer' process contains this buffer memory (it contains the entire
viewer, but the memory buffer can take most of the space).

\end{itemize}

%%%%%%
\subsubsection{MS Options --- Apply Button}
\label{section:display.ms.adjust.apply}

When viewing large MSs the display may be 
partially or completely grey in areas where the required data is not
currently in memory, either because no data has been loaded yet, or
because not all the selected data will fit into the allowed memory
(see {\tt Max. Visibility Memory} above).  When the
cursor is over such an area, the following message shows in the position
tracking area:
\small
\begin{verbatim}
   press 'Apply' on Adjust panel to load data
\end{verbatim}
\normalsize
Pressing the {\bf Apply} button (which lies below all the options) 
will reload the
memory buffer so that it includes the slice you are trying to view.

The message {\bf No Data} has a different meaning; in that
case, there simply {\it is} no data in the selected MS at the
indicated position.

For large measurement sets, loading visibility data into memory is the
most time-consuming step.  Progress feedback is provided in the
console window.  Again, careful selection of the data to be viewed can
greatly speed up retrieval.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Printing from the Viewer}
\label{section:display.print}

\begin{figure}[h!]
\begin{center}
%\pngname{viewer_printing}{6}
\pngname{viewer_jupiter_print}{6}
\caption{\label{fig:viewer_print} Printing the display to a hardcopy
of a file. From the {\bf Viewer Print Manager}, located in top right here and
accessed by the print icon or from the Data drop down menu, 
you can use the {\bf Save} button to save save an image or {\bf Print}
directly to a printer. To achieve the best results, it is often helpful to
adjust the settings in the {\bf Data Display Options} and {\bf Viewer Canvas Manager},
shown at right.} 
\hrulefill
\end{center}
\end{figure}

You can select {\tt Data:Print} from the drop down menu or click 
the {\bf Print} icon to bring up the {\bf Viewer Print Manager}. From this 
panel, you can {\bf Print} the contents of Display Panel to a hardcopy
or {\bf Save} them as an image in a format selected from the drop-down
menu at the bottom left of the window. Note that the save feature will
overwrite the file in question without prompting.

The Viewer Print Manager allows you to adjust the DPI, orientation,
and page format (Output Media) for Postscript or PDF files and to
scale the image to a desired pixel size for other images.

To achieve the best output it is usually advisable to adjust the settings
in the {\bf Viewer Print Manager}, {\bf Data Display Options}, 
and {\bf Viewer Canvas Manager} . For PDF and Postscript output, turning
the DPI up all the way yields the best-looking results. For other images,
a white background often makes for better looking images than the 
default black. It is often necessary to increase the {\bf Line Width}
in the {\bf Axis Label Properties} (in the {\bf Data Display Options} panel)
to ensure that the labels will be visible when printed.  Increasing from the default
of {\tt 1.4} to a value around {\tt 2} often works well.

Figure~\ref{fig:viewer_print} shows an example of printing to a file while
adjusting the {\bf Data Display Options} and {\bf Viewer Canvas Manager} to
improve the appearance of the plot.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Image Viewer ({\tt imview})}
\label{section:display.imview}

The {\tt imview} task offers scriptable access to many viewer options.
This enables the production of customized plots without invoking the GUI 
and allows one to open the viewer to a carefully selected state.

{\tt imview} has the following inputs:

\small
\begin{verbatim}
#  imview :: View an image
raster              =         {}        #  (Optional)  Raster filename (string)
                                        #   or complete raster config
                                        #   dictionary. The allowed dictionary
                                        #   keys are file (string), scaling
                                        #   (numeric), range (2 element numeric
                                        #   vector), colormap (string), and
                                        #   colorwedge (bool).
contour             =         {}        #  (Optional)  Contour filename (string)
                                        #   or complete contour config
                                        #   dictionary. The allowed dictionary
                                        #   keys are file (string), levels
                                        #   (numeric vector), unit (float), and
                                        #   base (float).
zoom                =          1        #  (Optional)  zoom can specify
                                        #   intermental zoom (integer), zoom
                                        #   region read from a file (string) or
                                        #   dictionary specifying the zoom
                                        #   region. The dictionary can have two
                                        #   forms. It can be either a simple
                                        #   region specified with blc (2 element
                                        #   vector) and trc (2 element vector)
                                        #   [along with an optional coord key
                                        #   ("pixel" or "world"; pixel is the
                                        #   default) or a complete region
                                        #   rectangle e.g. loaded with
                                        #   "rg.fromfiletorecord( )". The
                                        #   dictionary can also contain a
                                        #   channel (integer) field which
                                        #   indicates which channel should be
                                        #   displayed.
axes                =         -1        #  (Optional)  this can either be a
                                        #   three element vector (string) where
                                        #   each element describes what should
                                        #   be found on each of the x, y, and z
                                        #   axes or a dictionary containing
                                        #   fields "x", "y" and "z" (string).
out                 =         ''        #  (Optional)  Output filename or
                                        #   complete output config dictionary.
                                        #   If a string is passed, the file
                                        #   extension is used to determine the
                                        #   output type (jpg, pdf, eps, ps, png,
                                        #   xbm, xpm, or ppm). If a dictionary
                                        #   is passed, it can contain the
                                        #   fields, file (string), scale
                                        #   (float), dpi (int), or orient
                                        #   (landscape or portrait). The scale
                                        #   field is used for the bitmap formats
                                        #   (i.e. not ps or pdf) and the dpi
                                        #   parameter is used for scalable
                                        #   formats (pdf or ps).
async               =      False        #  If true the taskname must be started
                                        #   using imview(...)



\end{verbatim}
\normalsize

The {\tt raster} and {\tt contour} parameters specify which images to load
and how these images should be displayed. These parameters take 
python dictionaries as inputs. The fields in these dictionaries specify how
the image will be displayed.

An example call to {\tt imview} looks like this:

\small
\begin{verbatim}
imview(raster={'file': 'ngc5921.clean.image',
                       'range': [-0.01,0.03],
                       'colormap': 'Hot Metal 2',
                       'scaling': -1},
               contour={'file': 'ngc5921.clean.image'},
               axes={'x':'Declination'} ,
               zoom={'channel': 7, 'blc': [75,75], 'trc': [175,175],
                     'coord': 'pixel'},
               out='myout.png')
\end{verbatim}
\normalsize

The argument to {\tt raster} is enclosed in the curly braces \{ \} . Within these
braces are a number of "key":"value" pairs. Each sets an option in the viewer,
with the GUI parameter to set defined by the "key" and the value to set it to
defined by "value." In the example above, 'file':'ngc5921.clean.image' 
sets the file name of the raster image, 'range': [-0.01,0.03] sets the range of
pixel values used for the scaling.

{\tt contour} works similar to 'raster' but can accept multiple dictionaries in order to produce
multiple contour overlays on a single image. To specify multiple contour overlays, simply 
pass multiple dictionaries (comma delimited) in to the contour argument:

\small
\begin{verbatim}
 contour={'file': 'file1.image', 'levels': [1,2,3] },
         {'file': 'file2.image', 'levels': [0.006, 0.008, 0.010] }
\end{verbatim}
\normalsize

{\tt zoom} specifies the part of the image to be shown.

{\tt axes} defines what axes are shown. By default, the viewer 
will show 'x':'Right Ascension', 'y':'Declination' but one may also
view position-frequency images. 

{\tt out} defines the filename of the output, with the extension setting the file type. 

Currently, the following parameters are supported with additional functionality
planned for future releases:

\small
\begin{verbatim}
raster  -- (string) image file to open
           (dict)   file (string)     => image file to open
                    scaling (float)   => scaling power cycles
                    range (float*2)   => data range
                    colormap (string) => name of colormap
                    colorwedge (bool) => show color wedge?
contour -- (string) file to load as a contour
           (dict)   file (string)     => file to load
                    levels (float*N)  => relative levels
                    base (numeric)    => zero in relative levels
                    unit (numeric)    => one in the relative levels
zoom    -- (int)    integral zoom level
           (string) region file to load as the zoom region
           (dict)   blc (numeric*2)   => bottom left corner
                    trc (numeric*2)   => top right corner
                    coord (string)    => pixel or world
                    channel (int)     => chanel to display
           (dict)   <region record>   => record loaded
                                         e.g. rg.fromfiletorecord( )
axes    -- (string*3) dimension to display on the x, y, and z axes
           (dict)     x               => dimension for x-axes
                      y               => dimension for y-axes
                      z               => dimension for z-axes
out     -- (string) file with a supported extension
                    [jpg, pdf, eps, ps, png, xbm, xpm, ppm]
            (dict)    file (string)   => filename
                      format (string) => valid ext (filename ext overrides)
                      scale (numeric) => scale for non-eps, non-ps output
                      dpi (numeric)   => dpi for eps or ps output
                      orient (string) => portrait or landscape
\end{verbatim}
\normalsize

Examples are also found in {\tt help imview}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Measurement Viewer ({\tt msview})}
\label{section:display.msview}

The Measurement Viewer {\tt msview} is mostly a clone of the {\tt
  viewer} at this stage. A difference is that {\tt msview} allows the
user to select data before it is loaded into the GUI and displayed. A
screenshot is shown in Fig.\,\ref{fig:msview-selection} and selection
parameters are {\tt field, spectral window, time range, uv range,
  antenna, corr, scan, array, ms selection expression} in the usual
CASA selection syntax (see Sect.\,\ref{section:io.selection}). 


\begin{figure}[h!]
\begin{center}
%\gname{casa_inpclean1}{6}
%\pngname{clean_inputs_1}{6}
\pngname{msview-selection}{6}
\caption{\label{fig:msview-selection} Data selection in {\tt msview}.}
\hrulefill
\end{center}
\end{figure}
 