<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet type="text/xsl" ?>

<casaxml xmlns="http://casa.nrao.edu/schema/psetTypes.html"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:schemaLocation="http://casa.nrao.edu/schema/casa.xsd
file:///opt/casa/code/xmlcasa/xml/casa.xsd">


<!-- This is the task interface to ia.fitprofile           -->

<task type="function" name="specfit" category="analysis" visibility="experimental">

<shortdescription>Fit 1-dimensional gaussians and/or polynomial models to an image or image region</shortdescription>

<description>
</description>

<input>
    <param type="string" name="imagename" mustexist="true" >
    	<description>Name of the input image</description>
    	<value></value>
        <example>imagenam='ngc5921_task.image'</example>
    </param>

        <param type="string" direction="in" name="box">
            <description>Rectangular box in direction coordinate blc, trc. Default: entire image ("").</description>
            <value></value>
            <example>box="4,4,10,10"</example>
        </param>
        <param type="string" direction="in" name="region">
            <description>Region name, Default: no region ("").</description>
            <value></value>
            <example>region="myregion.rgn"</example>
        </param>
        <param type="string" direction="in" name="chans">
            <description>Channels to use. Channels must be contiguous. Default: all channels ("").</description>
            <value></value>
            <example>chans="4-11"</example>
        </param>
        <param type="string" direction="in" name="stokes">
            <description>Stokes planes to use. Planes must be contiguous. Default: all stokes ("").</description>
            <value></value>
            <example>stokes="I"</example>
        </param>
        <param type="int" direction="in" name="axis">
            <description>The profile axis. Default: use the spectral axis if one exists, axis 0 otherwise (&lt;0).</description>
            <value>-1</value>
            <example>axis=3</example>
        </param>
        <param type="string" direction="in" name="mask">
            <description>OTF mask, Boolean LEL expression or mask region.  Default: no mask ("").</description>
            <value></value>
        </param>
        <param type="int" direction="in" name="ngauss" subparam="true">
            <description>Number of Gaussian elements.  Default: 1.</description>
            <value>1</value>
            <example>ngauss=2</example>
        </param>
        <param type="int" direction="in" name="poly">
            <description>Order of polynomial element.  Default: do not fit a polynomial (&lt;0).</description>
            <value>-1</value>
            <example>poly=4</example>
        </param>
        <param type="string" direction="in" name="estimates">
            <description>Name of file containing initial estimates.  Default: No initial estimates ("").</description>
            <value/>
        </param>
        <param type="int" direction="in" name="minpts">
            <description>Minimum number of unmasked points necessary to attempt fit.</description>
            <value>0</value>
        </param>
        <param type="bool" direction="in" name="multifit">
            <description>If true, fit a profile along the desired axis at each pixel in the specified region. If false, average the non-fit axis pixels and do a single fit to that average profile. Default False.</description>
            <value>False</value>
            <example>multifit=True</example>
         </param>
        <param type="string" direction="in" name="model">
            <description>Name of model image. Default: do not write the model image ("").</description>
            <value></value>
            <example>model="mymodel.im"</example>
        </param>
        <param type="string" direction="in" name="residual">
            <description>Name of residual image. Default: do not write the residual image ("").</description>
            <value></value>
            <example>residual="myresid.im"</example>
        </param>
        <param type="string" direction="in" name="amp" subparam="true">
            <description>Name of amplitude solution image. Default: do not write the image ("").</description>
            <value/>
            <example>amp="amp"</example>
        </param>
        <param type="string" direction="in" name="amperr" subparam="true">
            <description>Name of amplitude solution error image. Default: do not write the image ("").</description>
            <value/>
            <example>amperr="ampErr"</example>
        </param>
        <param type="string" direction="in" name="center" subparam="true">
            <description>Name of center solution image. Default: do not write the image ("").</description>
            <value/>
            <example>center="center"</example>
        </param>
        <param type="string" direction="in" name="centererr" subparam="true">
            <description>Name of center solution error image. Default: do not write the image ("").</description>
            <value/>
            <example>centererr="centerErr"</example>
        </param>
        <param type="string" direction="in" name="fwhm" subparam="true">
            <description>Name of fwhm solution image. Default: do not write the image ("").</description>
            <value/>
            <example>fwhm="fwhm"</example>
        </param>
        <param type="string" direction="in" name="fwhmerr" subparam="true">
            <description>Name of fwhm solution error image. Default: do not write the image ("").</description>
            <value/>
            <example>fwhmerr="fwhmErr"</example>
        </param>
        <param type="string" direction="in" name="integral" subparam="true">
            <description>Prefix of ame of integral solution image. Name of image will have gaussian component number appended.  Default: do not write the image ("").</description>
            <value/>
            <example>integral="integral"</example>
        </param>
        <param type="string" direction="in" name="integralerr" subparam="true">
            <description>Prefix of name of integral error solution image. Name of image will have gaussian component number appended.  Default: do not write the image ("").</description>
            <value/>
            <example>integralerr="integralErr"</example>
        </param>
        
        <param type="bool" name="wantreturn">
            <description>Should a record summarizing the results be returned?</description>
            <value>True</value>
            <example>wantreturn=True</example>
        </param>
        <constraints>
            <when param="estimates">
                <equals type="string" value="">
                    <default param="ngauss">
                        <value>1</value>
                    </default>
                </equals>
            </when>
            <when param="multifit">
                <equals type="bool" value="True">
                    <default param="amp">
                        <value>""</value>
                    </default>
                    <default param="amperr">
                        <value>""</value>
                    </default>
                    <default param="center">
                        <value>""</value>
                    </default>
                    <default param="centererr">
                        <value>""</value>
                    </default>
                    <default param="fwhm">
                        <value>""</value>
                    </default>
                    <default param="fwhmerr">
                        <value>""</value>
                    </default>
                   <default param="integral">
                        <value>""</value>
                    </default>
                    <default param="integralerr">
                        <value>""</value>
                    </default>
            </equals>
        </when>
    </constraints>
</input>

<returns type="record"/>

<example>
    
This task simultaneously fits one or more gaussians and/or a polynomial to one dimensional profiles.

ARAMETER SUMMARY
imagename    Name of the input (CASA, FITS, MIRIAD) image
box          Direction plane box specification, "blcx, blcy, trcx, trcy". Only one box
             may be specified. If not specified, region is used if specified. If region
             is also not specified, entire directional plane unioned with any chans and
             stokes specification determines the region.
region       Optional region file to use.
chans        Optional contiguous frequency channel number specification. Not used if
             region is specified. Default is all channels.
stokes       Contiguous stokes planes specification. Not used if region is specified.
             Default is all stokes.     
axis         Axis along which to do the fit(s). &lt;0 means use the spectral axis or the
             zeroth axis if a spectral axis is not present.
mask         Optional mask specification.
ngauss       Maximum number of gaussians to fit.
poly         Order of polynomial to fit. &lt;0 means do not fit a polynomial.
estimates    Name of file containing initial gaussian estimates.
minpts       Minimum number of points necessary to attempt a fit.
multifit     Fit models at each pixel in region (true) or average profiles and fit a single model (false).
model        Name of model image to write.
residual     Name of residual image to write.
amp          Name of amplitude solution image. Default: do not write the image ("")
amperr       Name of amplitude solution error image. Default: do not write the image ("")
center       Name of center solution image. Default: do not write the image ("")
centererr    Name of center solution error image. Default: do not write the image ("")
fwhm         Name of fwhm solution image. Default: do not write the image ("")
fwhmerr      Name of fwhm solution error image. Default: do not write the image ("")
integral     Name of integral solution image. Default: do not write the image ("")
integralerr  Name of integral solution error image. Default: do not write the image ("")
wantreturn   If true, return a record summarizing the fit results, if false, return false.

The axis parameter indicates on which axis profiles should be fit; a value &lt;0 indicates the spectral axis should be used, or if one does not exist,
that the zeroth axis should be used.

The ngauss parameter indicates the maximum number of gaussians that should be fit. If appropriate the fitter will fit fewer than this number.
In the case where an estimates file is supplied, ngauss is ignored (see below). The poly parameter indicates the order of the polynomial to
fit; a value &lt;0 indicates that no polynomial should be fit. An error will occur if ngauss=0 and poly&lt;0, as this indicates there
is nothing to fit. 

The minpts parameter indicates the minimum number of unmasked points that must be present in order for a fit
to be attempted. When multifit=T, positions with too few good points will have 

The multifit parameter indicates if profiles should be fit at each pixel in the selected region (true), or if the profiles in that region should be
averaged and the fit done to that average profile (false).

The model and residual parameters indicate the names of the model and residual images to be written; blank values inidcate that these images
should not be written.

If wantreturn=true, the return value is a dictionary containing the following keys and values.  Arrays have the shape of the specified region
collapsed along the fit axis with the fit axis having dimension of 1.
attempted: a boolean array indicating which fits were attempted (eg if too few unmasked points, a fit will not be attempted).
converged: a boolean array indicating which fits converged. False if the fit was not attempted.
niter: an int array indicating the number of iterations for each profile, &lt;0 if the fit did not converge
ncomps: the number of components (gaussians + polynomial) fit for the profile, &lt;0 if the fit did not converge
xUnit: the abscissa unit
yUnit: the ordinate unit

In addition, the following keys are appended by the component number to indicate which component they correspond to, eg, fwhm0, fwhm1, etc.
At pixels where fits were not attempted or did not converge, numerical arrays will have values of NaN.
type[0,1,...] The type of component (GAUSSIAN or POLYNOMIAL)
center[0,1,...] The fitted center value for the nth component which is a gaussian.
fwhm[0,1,...] The fitted FWHM value for the nth component which is a gaussian.
amp[0,1,...] The fitted amplitude value for the nth component which is a gaussian.
integral[0,1,...] The integral value for the nth component which is a gaussian.
centerErr[0,1,...], fwhmErr[0,1,...], ampErr[0,1,...], integralErr[0,1,...] The associated errors for the nth component which is a gaussian.

One can also write none, any or all of the solution and error images for gaussian fits via the parameters amp, amperr, center, centererr,
fwhm, and fwhmerr when doing multi-pixel fits. The specified parameter value will by appended by "_n" where n is the gaussian
component number. Writing analogous images for polynomial coefficients is not yet supported. Pixels for which fits were not attempted
or did not converge will be masked as bad.

Currently, the polynomial coefficients and their errors are not returned, although they are logged.

INITIAL ESTIMATES
Initial estimates for gaussian models can be specified in an estimates file. Polynomial coefficient initial estimates cannot
be supplied. If given, the estimates file must contain initial estimates for all gaussian models to be fit. The value
of the number of gaussians to fit is gotten from the number of estimates in the file. The file can contain comments. These
are indicated by a "#" at the beginning of a line. All non-comment lines will be interpreted as initial estimates. The
format of such a line is

[peak intensity], [center], [fwhm], [optional fixed parameter string]

The first three values are required and must be numerical values. The peak intensity must be expressed in map units, while the
center and fwhm must be specified in pixels. The fourth value is optional and if present, represents the parameter(s)
that should be held constant during the fit. Any combination of the characters 'p' (peak), 'c' (center), and 'f' (fwhm) are
permitted, eg "fc" means hold the fwhm and the center constant during the fit. Fixed parameters will have no error associated
with them. Here is an example file:

# estimates file indicating that two gaussians should be fit
# first guassian estimate, peak=40, center at pixel number 10.5, fwhm = 5.8 pixels, all parameters allowed to vary during
# fit
40, 10.5, 5.8
# second gaussian, peak = 4, center at pixel number 90.2, fwhm = 7.2 pixels, hold fwhm constant
4, 90.2, 7.2, f
# end file

In the case of multifit=True, the initial estimates from the file will be applied to the location of the
first fit. This is normally the bottom left corner of the region selected. If masked or not enough good
points to perform a fit, the fitting proceeds to the next pixel with the pixel value of the lowest numbered
axis changing the fastest. Once a successful fit has been performed at a location, subsequent fits will
use the results of a fit for a nearest pixel for which a previous fit was successful as the initial estimate.
The fixed parameter string will be honored for every fit performed when multifit=True.

res = specfit(imagename="myspectrum.im", ngauss=2, box="3,3,4,5", poly=2, multifit=true, wantreturn=true)
# reshape fit parameters to correspond to input pixels
mycenter0 = res["center0"].reshape([2,3], order="F")

</example>
    
</task>

</casaxml>

