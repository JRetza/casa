

\section{The MSTransform framework}\label{Sec:Running}
% Add parts from Justo's document.
% I/O improvement by avoiding read/write to disk multiple times.
% order of running the transformations
% independence of each transformation.
% new VI???
The mstransform task has been designed to be a single place for many
common operations used in the pre-imaging steps of interferometric
data reduction. The task has the following capabilities, which can be done
independently or combined. Except for split which is the default state of 
the task, each transformation has a boolean parameter to switch it on
or off.

\begin{enumerate}
\item Split into a new MS using data selection parameters.
\item Partition into a new Multi-MS using data selection parameters.
\item Combination of spectral windows.
\item Channel averaging using FLAG or WEIGHT_SPECTRUM as the weights.
\item Hanning smoothing.
\item Reference frame transformation, similar to cvel.
\item Separation of spectral windows, which does not have an independent
boolean switch, but it can be independently applied when regridms=True and
the nspw parameter is set to > 1.
\item Time averaging.

\end{enumerate}


Documentation for the task and tool can be found in:
\htmladdnormallink{Task Documentation}{http://casa.nrao.edu/docs/TaskRef/TaskRef.html}
\htmladdnormallink{Tool Documentation} {http://casa.nrao.edu/docs/CasaRef/CasaRef.html}

\subsection{Splitting capabilities}
Task mstransform behaves like split in all cases that concern sub-table re-indexing
and selection. It does not support multiple channel selections, which are separated by
a semi-colon. If there is an spw selection, it will re-index the spws starting from 0.

A datacolumn specifies which column will be used for the transformations. It is
possible to make real a virtual MODEL column, by setting the parameter
{\it datacolumn} to any of the values 'model', 'all' or 'data,model,corrected'
and then setting the sub-parameter {\it realmodelcol} to True. This will copy the virtual
column to a physical MODEL column in the MS main table. The virtual model column
will be deleted afterwards.

The user can control whether to create a WEIGHT_SPECTRUM column in the output MS or
not. If the input MS does not have a WEIGHT_SPECTRUM, by setting the parameter
{\it usewtspectrum} to True, the task will create a WEIGHT_SPECTRUM from the values
in the WEIGHT column, such that each channel in the WEIGHT_SPECTRUM will get WEIGHT/nChannels.
By default, {\it usewtspectrum} is set to False.

\begin{verbatim}
    mstransform('uid.ms', outputvis='myout.ms', datacolumn='data', spw='0,3,5')
\end{verbatim}

\subsection{Partition and Multi-MS support}
From CASA 4.1.0 onwards, task partition uses the MSTransform framework.
Task mstransform (or partition) can partition an MS to create an MMS using
different separation axes. The default is to separate using both scan and spw axes.
It supports channel selections and re-indexing of sub-tables. 

The user has the option to create an output MMS in parallel (using simple_cluster) or
in sequential. Set the parameter {\it parallel} to True to use simple_cluster. Note that
for small MSs, we recommend to create MMSs in sequential, as the overhead of creating
a cluster and managing the engines can become significant.

The combination of some transformations and createmms=True is not possible in
some cases, depending on the choice of {\it separationaxis}. The following table summarizes this:

\begin{verbatim}

separationaxis  combinespws  nspw > 1  regridms  chanaverage  timespan='scan' hanning
--------------------------------------------------------------------------------------
spw                NO         NO         YES        YES           YES           YES
scan               YES        YES        YES        YES           YES*          YES
both               NO         NO         YES        YES           YES*          YES

* --> we can partition per scan or scan,spw but cannot let timebins span changes in scan
      when timeaverage=True. The task will reset timespan to None in these cases.

\end{verbatim}

Depending on the structure of the data, some partitions will have empty data.
For example, if an MS has scan=1 with spw=0,1 and scan=2 only with spw=0. If
you run partition with separationaxis='both', it will try to create the
following group of subMSs.

\begin{verbatim}

subMS            scan      spw
----------------------------------
subMS.0000.ms    1         0
subMS.0001.ms    2         0
subMS.0002.ms    1         1
subMS.0003.ms    2         1  -----> NULL selection

\end{verbatim}

Obviously, subMS.0003.ms has not data in scan=2 spw=1, so it would naturally
issue a NULL MS Selection exception. The partition/mstransform task tries to
pre-select the subMSs before actually sending them to the engines and catchs 
this type of NULL selections. It issues a warning for these cases and continues.
The output MMS of the above example would contain 3 subMSs, running from 0000
to 0002.

You can use the task listpartition to verify the contents of an MMS.
Listpartition is similar to listobs and can also save the output to a file
or return it as a Python dictionary.

\begin{verbatim}
    mstransform('uid.ms', outputvis='myout.mms', createmms=True, separationaxis='spw', datacolumn='all', parallel=False)
    
    or
    
    partition('uid.ms', outputvis='myout.mms', separationaxis='spw', datacolumn='all', parallel=False)
    
\end{verbatim}

NOTE: the default values of partition and mstransform are different.
By default, partition will create an MMS using simple_cluster in parallel.
On the other hand, the default of mstransform is createmms=False and
parallel=False.

\subsection{Combination of spectral windows}
Task mstransform can combine spectral windows independently or
with a reference frame transformation. When {\it combinespws} is set to True, the task will
combine all the selected spectral windows into one. The index of the output spw
will be 0. When there are overlapping channels, they will be averaged to form one
output channel.

\begin{verbatim}
    mstransform('uid.ms', outputvis='myout.ms', datacolumn='data', spw='1,3,5', combinespws=True)
\end{verbatim}

\subsubsection{Handling spectral windows with different sensitivities}
Whenever the data to be combined has different EXPOSURE values in the spectral
windows, mstransform will use the WEIGHT\_SPECTRUM for the combination. If
WEIGHT\_SPECTRUM is not available, it will use the values from the WEIGHT
column. Each output channel is calculated using the following equation:

\begin{verbatim}
outputChannel_j = SUM(inputChannel_i*contributionFraction_i*inputWeightSpectrum_i) 
                --------------------------------------------------------------------
                        SUM(contributionFraction_i*inputWeightSpectrum_i)

where:
    contributionFraction_i are geometrical factors to take into account any gaps or overlaps in the spws.
\end{verbatim}

\subsection{Channel averaging}
Similar to task split, mstransform can average the selected channels based on a
width parameter. The parameter {\it chanbin} can be either an integer or a list of
integers that will apply to each spw in the selection.

A parameter called {\it useweights} controls the type of weights to use in the
averaging. The options are flags that will consider the FLAG column and spectrum
that will consider the WEIGHT_SPECTRUM column per channel. The calculation is
done as follows:

\begin{verbatim}
When using flags:
    Avg = SUM(Chan_i*Flag_i)/SUM(Flag_i)     
(where boolean values are converted to 0 for True and 1 for False)

When using weights:
    Avg = SUM(Chan_i*WeightSpectrum_i)/SUM(WeightSpectrum_i)     
(using directly the WEIGHT_SPECTRUM values provided that they are already numerical)

\end{verbatim}

\begin{verbatim}
    mstransform('uid.ms', outputvis='myout.ms', datacolumn='data', spw='5', chanaverage=True, chanbin=2, useweights='flags')
\end{verbatim}

\subsection{Reference frame transformation}
The parameter {\it regridms} in mstransform can do what task cvel does, such as
regrid an MS to a new spectral window, channel structure or frame. The option {\it regridms}
in mstransform differs from task cvel in a few cases. Task cvel has a
parameter {\it passall} to copy or not the non-selected spws into the output MS. In 
mstransform we only consider the {\it passall=False}, meaning that we only consider the
selected spws of the MS. Task cvel always combines spws when changing the reference
frame, while mstransform can do both cases. The combination of spectral windows in mstransform
is controlled by the independent parameter {\it combinespws}.

Whenever the {\it width} parameter is > 2, a pre-averaging is done. 

\begin{verbatim}
    mstransform('uid.ms', outputvis='myout.ms', spw='1~3', regridms=True, nchan=10, outframe='LSRK')
\end{verbatim}

\subsection{Separation of spectral windows}
This transformation is done as part of the {\it regridms} transformation
although it can be done without any frame transformation. The mstransform
task can separate the spectral windows into a regular grid specified by the
user using the parameter {\it nspw}. This is a new feature in CASA
4.1.0+ and can be applied in many use-cases. %(Expand and list some use-cases)

If {\it nspw} is greater than 1, the input spws will be separated into the given
number. If {\it nchan} is set, it will refer to the number of channels to have in each
separated spw. Note that internally, the framework will first combine the input
spws to take gaps and overlaps into account, before separating them in the desired
number.

\begin{verbatim}
    mstransform('uid.ms', outputvis='myout.ms', spw='1', regridms=True, nspw=3, nchan=10)
\end{verbatim}

\subsection{Hanning smoothing}
Set the parameter {\it hanning} to True to Hanning smooth the MS. Contrary to the
hanningsmooth task, mstransform creates a new output MS and writes the smoothed transformation
to the DATA column of the output MS, not to the CORRECTED_DATA column.

Another difference with respect to the hanningsmooth task is that the transformation will be 
applied to all the data columns requested by the user in the parameter {\it datacolumn}. If the 
requested column does not exist, it will exit with an error. 

\begin{verbatim}
    mstransform('uid.ms', outputvis='myout.ms', hanning=True)
\end{verbatim}

\subsection{Time averaging}
% Add stuff in here
Similar to split, this task can average the MS in time, based on a set of parameters....

%timespan
%minbaselines
%quantize_c


\section{Examples}\label{Sec:Examples}
How to run the mstransform task for several common use-cases.

\begin{enumerate}
\item Split three spectral windows of a field and save to a new MS.
\begin{verbatim}
mstransform(vis='inp.ms', outputvis='out.ms', datacolumn='data', spw='1~3', field='JUPITER')
\end{verbatim}
\item Combine four spectral windows into one.
\begin{verbatim}
mstransform(vis='inp.ms', outputvis='out.ms', combinespws=True, spw='0~3')
\end{verbatim}
\item Apply Hanning smoothing in MS with 24 spws. Do not combine spws.
\begin{verbatim}
mstransform(vis='inp.ms', outputvis='out.ms', hanning=True, datacolumn='data')
\end{verbatim}
\item Create a multi-MS parted per spw, in paralell, based on the input channel selection.
\begin{verbatim}
mstransform(vis='inp.ms', outputvis='out.mms', spw='0~4,5:1~10', createmms=True,
            separationaxis='spw', parallel=True)
\end{verbatim}
\item Average channels in CORRECTED column using a bin of 3 channels in XX.
\begin{verbatim}
mstransform(vis='inp.ms', outputvis='out.ms', spw='0:5~16', correlation='XX', 
            chanaverage=True, chanbin=3)
\end{verbatim}
\item Combine spws and regrid MS to new channel structure. Average width is 2 channels.
\begin{verbatim}
mstransform(vis='inp.ms', outputvis='out.ms', datacolumn='DATA', field='11',
            combinespws=True, regridms=True, nchan=1, width=2)
\end{verbatim}
\item Regrid MS to new channel structure, change reference frame to BARY and set
new phasecenter to that of field 1. Use mode frequency for the parameters.
\begin{verbatim}
mstransform(vis='inp.ms', outputvis='out.ms', datacolumn='DATA', spw='0', field='1', 
            regridms=True, nchan=2, mode='frequency', width='3MHz', start='115GHz', 
            outframe='BARY', phasecenter=1)
\end{verbatim}
\item Set a custom tile shape for the output MS using the parameter tileshape. This will
set the tileshape to 4 correlations, 64 channels and 1024 rows.
\begin{verbatim}
mstransform(vis='inp.ms', outputvis='out.ms', tileshape=[4,64,1024])
\end{verbatim}
\item Separate a large input spw into a regular grid of 5 output spws, each with 10 channels.
\begin{verbatim}
mstransform(vis='inp.ms', outputvis='out.ms', spw='0', regridms=True, nchan=10, nspw=5)
\end{verbatim}



\end{enumerate}

\section{Frequently Asked Questions}\label{Sec:FAQ}
\begin{description}
  \item[Q1: How to run mstransform like cvel?] \hfill 
  Set the parameter {\it regridms} to True. If there is more than one spw in the
selection, set also {\it combinespws} to True because cvel always combines the selected
spws.

  \item[Q2: How to run mstransform like split and the width parameter?] \hfill 
  To do channel average, set {\it chanaverage} to True and set {\it chanbin} to the
  the same value of the {\it width} parameter in split.

\end{description}

