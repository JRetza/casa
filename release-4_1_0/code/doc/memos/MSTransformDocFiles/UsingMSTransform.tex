

\section{The MSTransform framework}\label{Sec:Running}
% Add parts from Justo's document.
% I/O improvement by avoiding read/write to disk multiple times.
% order of running the transformations
% independence of each transformation.
% new VI???
Documentation for the task and tool can be found in:
\htmladdnormallink{Task Documentation}{http://casa.nrao.edu/docs/TaskRef/TaskRef.html}
\htmladdnormallink{Tool Documentation} {http://casa.nrao.edu/docs/CasaRef/CasaRef.html}

\subsection{Splitting capabilities}
Task mstransform behaves like split in all cases that concern sub-table re-indexing
and selection. It does not support multiple channel selections, which are separated by
a semi-colon. If there is an spw selection, it will re-index the spws starting from 0.

\subsection{Partition and Multi-MS support}
Task mstransform can do everything that task partition does and more. It supports
channel selections and re-indexing of spw sub-tables. The sub-tables are consolidated
in the output MMS, which does not happen in task partition. %Explain POINTING,SYSCAL tables

The user has the option to create an output MMS in parallel (using simple_cluster) or
in sequential. Set the parameter {\it parallel} to True to use simple_cluster. Note that
for small MSs, we recommend to create MMSs in sequential, as the overhead of creating
a cluster and managing the engines can become significant.

The combination of some transformations and createmms=True is not possible in
some cases, depending on the choice of {\it separationaxis}. The following table summarizes this:

\begin{verbatim}

separationaxis  combinespws  nspw > 1  regridms  chanaverage  timespan='scan' hanning
--------------------------------------------------------------------------------------
spw                NO         NO         YES        YES           YES           YES
scan               YES        YES        YES        YES           YES*          YES
both               NO         NO         YES        YES           YES*          YES

* --> we can partition per scan or scan,spw but cannot let timebins span changes in scan
      when timeaverage=True. The task will reset timespan to None in these cases.

\end{verbatim}

% Add the forbidden combinations of axis and transformations

\subsection{Combination of spectral windows}
Task mstransform can combine spectral windows independently or
with a reference frame transformation. When {\it combinespws} is set to True, the task will
combine all the selected spectral windows into one. The index of the output spw
will be 0. When there are overlapping channels, they will be averaged to form one
output channel.

\subsection{Channel averaging}
Similar to task split, mstransform can average the selected channels based on a
width parameter. The parameter {\it chanbin} can be either an integer or a list of
integers that will apply to each spw in the selection.

A parameter called {\it useweights} controls the type of weights to use in the
averaging. The options are flags that will consider the FLAG column and spectrum
that will consider the WEIGHT_SPECTRUM column.

% use weights parameter

\subsection{Reference frame transformation}
The parameter {\it regridms} in mstransform can do what task cvel does, such as
regrid an MS to a new spectral window, channel structure or frame. The option {\it regridms}
in mstransform differs from task cvel in a few cases. Task cvel has a
parameter {\it passall} to copy or not the non-selected spws into the output MS. In 
mstransform we only consider the {\it passall=False}, meaning that we only consider the
selected spws of the MS. Task cvel always combines spws when changing the reference
frame, while mstransform can do both cases. The combination of spectral windows in mstransform
is controlled by the independent parameter {\it combinespws}.

Apart from these features, mstransform can also separate the spectral
windows into a regular grid specified by the user using the parameter
{\it nspw}. This is a new feature in CASA
4.1 and can be applied in many use-cases. %(Expand and list some use-cases)

If {\it nspw} is greater than 1, the input spws will be separated into the given
number. If {\it nchan} is set, it will refer to the number of channels to have in each
separated spw. Note that internally, the framework will first combine the input
spws to take gaps and overlaps into account, before separating them in the desired
number.

\subsection{Hanning smoothing}
Set the parameter {\it hanning} to True to Hanning smooth the MS. Contrary to the
hanningsmooth task, mstransform creates a new output MS and writes the smoothed transformation
to the DATA column of the output MS, not to the CORRECTED_DATA column.

Another difference with respect to the hanningsmooth task is that the transformation will be 
applied to all the data columns requested by the user in the parameter {\it datacolumn}. If the 
requested column does not exist, it will exit with an error. 

\subsection{Time averaging - To be implemented}
% Add stuff in here
%Similar to split, this task can average the MS in time, based on a set of parameters.

%timespan
%minbaselines
%quantize_c


\section{Examples}\label{Sec:Examples}
How to run the mstransform task for several common use-cases.

\begin{enumerate}
\item Split three spectral windows of a field and save to a new MS.
\begin{verbatim}
mstransform(vis='inp.ms', outputvis='out.ms', datacolumn='data', spw='1~3', field='JUPITER')
\end{verbatim}
\item Combine four spectral windows into one.
\begin{verbatim}
mstransform(vis='inp.ms', outputvis='out.ms', combinespws=True, spw='0~3')
\end{verbatim}
\item Apply Hanning smoothing in MS with 24 spws. Do not combine spws.
\begin{verbatim}
mstransform(vis='inp.ms', outputvis='out.ms', hanning=True, datacolumn='data')
\end{verbatim}
\item Create a multi-MS parted per spw, in paralell, based on the input channel selection.
\begin{verbatim}
mstransform(vis='inp.ms', outputvis='out.mms', spw='0~4,5:1~10', createmms=True,
            separationaxis='spw', parallel=True)
\end{verbatim}
\item Average channels in CORRECTED column using a bin of 3 channels in XX.
\begin{verbatim}
mstransform(vis='inp.ms', outputvis='out.ms', spw='0:5~16', correlation='XX', 
            chanaverage=True, chanbin=3)
\end{verbatim}
\item Combine spws and regrid MS to new channel structure. Average width is 2 channels.
\begin{verbatim}
mstransform(vis='inp.ms', outputvis='out.ms', datacolumn='DATA', field='11',
            combinespws=True, regridms=True, nchan=1, width=2)
\end{verbatim}
\item Regrid MS to new channel structure, change reference frame to BARY and set
new phasecenter to that of field 1. Use mode frequency for the parameters.
\begin{verbatim}
mstransform(vis='inp.ms', outputvis='out.ms', datacolumn='DATA', spw='0', field='1', 
            regridms=True, nchan=2, mode='frequency', width='3MHz', start='115GHz', 
            outframe='BARY', phasecenter=1)
\end{verbatim}
\item Set a custom tile shape for the output MS using the parameter tileshape. This will
set the tileshape to 4 correlations, 64 channels and 1024 rows.
\begin{verbatim}
mstransform(vis='inp.ms', outputvis='out.ms', tileshape=[4,64,1024])
\end{verbatim}
\item Separate a large input spw into a regular grid of 5 output spws, each with 10 channels.
\begin{verbatim}
mstransform(vis='inp.ms', outputvis='out.ms', spw='0', regridms=True, nchan=10, nspw=5)
\end{verbatim}



\end{enumerate}

\section{Frequently Asked Questions}\label{Sec:FAQ}
\begin{description}
  \item[Q1: How to run mstransform to mimic cvel?] \hfill 
  Set the parameter {\it regridms}I to True. If there is more than one spw in the
selection, set also {\it combinespws} to True because cvel always combines the selected
spws.

  \item[Q2: How to run mstransform to mimic split and the width parameter?] \hfill 
  To do channel average, set {\it chanaverage} to True and set {\it chanbin} to the
  the same value of the {\it width} parameter in split.

\end{description}

